<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CareerConnect - Admin Panel</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #1877f2;
      --secondary-color: #42b72a;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --bg-color: #f0f2f5;
      --card-bg: #ffffff;
      --text-primary: #050505;
      --text-secondary: #65676b;
      --divider: #e4e6eb;
      --hover-bg: #f2f2f2;
      --shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.1);
      --radius: 12px;
      --radius-lg: 16px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-color);
      color: var(--text-primary);
      line-height: 1.5;
    }

    /* Login Form Styles */
    .login-container {
      max-width: 400px;
      margin: 100px auto;
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 32px;
      box-shadow: var(--shadow-lg);
    }

    .login-header {
      text-align: center;
      margin-bottom: 24px;
    }

    .login-header h1 {
      color: var(--primary-color);
      font-size: 28px;
      margin-bottom: 8px;
    }

    .login-header p {
      color: var(--text-secondary);
    }

    .login-form input {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 16px;
      border: 1px solid var(--divider);
      border-radius: 6px;
      font-size: 16px;
      font-family: inherit;
    }

    .login-form input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(24, 119, 242, 0.2);
    }

    .login-btn {
      width: 100%;
      padding: 12px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin-bottom: 16px;
    }

    .login-btn:hover {
      background: #0e6ce0;
    }

    .login-error {
      color: var(--danger-color);
      text-align: center;
      margin-top: 12px;
      display: none;
    }

    /* Header */
    header {
      background: var(--card-bg);
      box-shadow: var(--shadow);
      padding: 0 16px;
      position: sticky;
      top: 0;
      z-index: 100;
      display: none;
      align-items: center;
      height: 56px;
    }

    .header-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
    }

    .logo {
      display: flex;
      align-items: center;
      color: var(--primary-color);
      font-weight: bold;
      font-size: 24px;
      text-decoration: none;
    }

    .logo i {
      margin-right: 8px;
    }

    .admin-actions {
      display: flex;
      gap: 12px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: #0e6ce0;
    }

    .btn-danger {
      background: var(--danger-color);
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .btn-warning {
      background: var(--warning-color);
      color: var(--text-primary);
    }

    .btn-warning:hover {
      background: #e0a800;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--divider);
      color: var(--text-primary);
    }

    .btn-outline:hover {
      background: var(--hover-bg);
    }

    /* Main Container */
    .main-container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 16px;
      display: none;
    }

    /* Tabs */
    .admin-tabs {
      display: flex;
      border-bottom: 1px solid var(--divider);
      margin-bottom: 20px;
      background: var(--card-bg);
      border-radius: var(--radius) var(--radius) 0 0;
      overflow: hidden;
    }

    .tab {
      padding: 16px 24px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .tab.active {
      border-bottom-color: var(--primary-color);
      color: var(--primary-color);
      background: rgba(24, 119, 242, 0.05);
    }

    .tab:hover {
      background: var(--hover-bg);
    }

    /* Content Sections */
    .content-section {
      display: none;
      background: var(--card-bg);
      border-radius: 0 var(--radius) var(--radius) var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
    }

    .content-section.active {
      display: block;
    }

    /* User List */
    .users-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .user-card {
      background: var(--card-bg);
      border: 1px solid var(--divider);
      border-radius: var(--radius);
      padding: 20px;
      transition: all 0.2s ease;
    }

    .user-card:hover {
      box-shadow: var(--shadow-lg);
    }

    .user-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .user-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      overflow: hidden;
      background: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 20px;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .user-details h3 {
      margin-bottom: 4px;
      font-size: 18px;
    }

    .user-details p {
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .user-status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      margin-top: 4px;
    }

    .status-active {
      background: #d4edda;
      color: #155724;
    }

    .status-suspended {
      background: #fff3cd;
      color: #856404;
    }

    .status-deleted {
      background: #f8d7da;
      color: #721c24;
    }

    .user-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .user-stats {
      display: flex;
      gap: 16px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--divider);
    }

    .stat {
      text-align: center;
    }

    .stat-value {
      font-size: 16px;
      font-weight: bold;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* Complaints List */
    .complaints-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .complaint-card {
      background: var(--card-bg);
      border: 1px solid var(--divider);
      border-radius: var(--radius);
      padding: 20px;
      transition: all 0.2s ease;
    }

    .complaint-card:hover {
      box-shadow: var(--shadow-lg);
    }

    .complaint-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .complaint-user {
      font-weight: bold;
      color: var(--primary-color);
    }

    .complaint-date {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .complaint-reason {
      background: var(--hover-bg);
      padding: 8px 12px;
      border-radius: 6px;
      margin-bottom: 12px;
      font-weight: 500;
    }

    .complaint-details {
      margin-bottom: 16px;
      line-height: 1.6;
    }

    .complaint-status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-reviewed {
      background: #d1ecf1;
      color: #0c5460;
    }

    .status-resolved {
      background: #d4edda;
      color: #155724;
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-content {
      background: white;
      border-radius: var(--radius);
      width: 100%;
      max-width: 500px;
      padding: 24px;
      box-shadow: var(--shadow-lg);
    }

    .modal-header {
      margin-bottom: 16px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 8px;
    }

    .modal-body {
      margin-bottom: 24px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .form-control {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--divider);
      border-radius: 6px;
      font-size: 16px;
      font-family: inherit;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(24, 119, 242, 0.2);
    }

    textarea.form-control {
      resize: vertical;
      min-height: 100px;
    }

    .modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    /* Search and Filters */
    .search-container {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }

    .search-box {
      display: flex;
      gap: 12px;
    }

    .search-box input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 20px;
      border: 1px solid var(--divider);
      background: var(--bg-color);
      font-size: 16px;
    }

    .filters {
      display: flex;
      gap: 12px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .filter-select {
      padding: 8px 12px;
      border: 1px solid var(--divider);
      border-radius: 6px;
      background: var(--bg-color);
      font-size: 14px;
    }

    /* Loading State */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .loading i {
      font-size: 32px;
      margin-bottom: 16px;
      color: var(--primary-color);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .empty-state i {
      font-size: 48px;
      margin-bottom: 16px;
      color: #ddd;
    }

    /* NEW: Detailed View Styles */
    .user-details-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 20px;
    }

    .detail-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--divider);
    }

    .detail-label {
      font-weight: 500;
      color: var(--text-secondary);
    }

    .detail-value {
      font-weight: 400;
    }

    .user-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      margin: 20px 0;
    }

    .stat-card {
      background: var(--bg-color);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }

    .stat-number {
      font-size: 24px;
      font-weight: bold;
      color: var(--primary-color);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .complaint-timeline {
      margin: 20px 0;
    }

    .timeline-item {
      display: flex;
      margin-bottom: 16px;
      position: relative;
    }

    .timeline-item:not(:last-child)::after {
      content: '';
      position: absolute;
      left: 20px;
      top: 40px;
      bottom: -20px;
      width: 2px;
      background: var(--divider);
    }

    .timeline-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 16px;
      flex-shrink: 0;
      z-index: 1;
    }

    .timeline-content {
      flex: 1;
    }

    .timeline-date {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .timeline-text {
      font-size: 14px;
    }

    .full-description {
      background: var(--bg-color);
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
      line-height: 1.6;
    }

    .action-history {
      margin-top: 20px;
    }

    .history-item {
      background: var(--bg-color);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .modal-lg {
      max-width: 800px;
    }

    .modal-xl {
      max-width: 1000px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .user-header {
        flex-direction: column;
        gap: 12px;
      }

      .user-actions {
        width: 100%;
        justify-content: flex-start;
      }

      .admin-tabs {
        flex-wrap: wrap;
      }

      .tab {
        flex: 1;
        min-width: 120px;
        text-align: center;
      }

      .modal {
        padding: 10px;
      }

      .user-details-grid {
        grid-template-columns: 1fr;
      }
      
      .modal-lg, .modal-xl {
        max-width: 95%;
      }
    }
  </style>
</head>
<body>
  <!-- Login Form -->
  <div class="login-container" id="loginContainer">
    <div class="login-header">
      <h1>CareerConnect Admin</h1>
      <p>Admin Panel Login</p>
    </div>
    <div class="login-form">
      <input type="email" id="adminEmail" placeholder="Admin Email" required>
      <input type="password" id="adminPassword" placeholder="Password" required>
      <button class="login-btn" onclick="adminLogin()">Login</button>
      <div class="login-error" id="loginError">Invalid email or password</div>
    </div>
  </div>

  <!-- Header -->
  <header id="adminHeader">
    <div class="header-container">
      <div class="logo">
        <i class="fas fa-briefcase"></i>
        CareerConnect Admin
      </div>
      <div class="admin-actions">
        <span id="adminWelcome" style="margin-right: 12px;"></span>
        <button class="btn btn-danger" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>
  </header>

  <!-- Main Container -->
  <div class="main-container" id="mainAdminContainer">
    <!-- Tabs -->
    <div class="admin-tabs">
      <div class="tab active" onclick="switchTab('users')">
        <i class="fas fa-users"></i> User Management
      </div>
      <div class="tab" onclick="switchTab('complaints')">
        <i class="fas fa-flag"></i> Complaints
        <span id="pendingComplaintsBadge" style="display: none;" class="status-pending" style="margin-left: 8px; padding: 2px 6px; border-radius: 10px; font-size: 12px;">0</span>
      </div>
    </div>

    <!-- Users Management Section -->
    <div id="usersSection" class="content-section active">
      <div class="search-container">
        <div class="search-box">
          <input type="text" id="userSearch" placeholder="Search users by name, email, or profession..." onkeyup="filterUsers()">
          <button class="btn btn-primary" onclick="filterUsers()">
            <i class="fas fa-search"></i> Search
          </button>
        </div>
        <div class="filters">
          <select id="statusFilter" class="filter-select" onchange="filterUsers()">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="suspended">Suspended</option>
            <option value="deleted">Deleted</option>
          </select>
          <select id="typeFilter" class="filter-select" onchange="filterUsers()">
            <option value="">All Types</option>
            <option value="normal">Normal User</option>
            <option value="professional">Professional</option>
          </select>
        </div>
      </div>

      <div class="users-list" id="usersList">
        <div class="loading">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Loading users...</p>
        </div>
      </div>
    </div>

    <!-- Complaints Section -->
    <div id="complaintsSection" class="content-section">
      <div class="search-container">
        <div class="search-box">
          <input type="text" id="complaintSearch" placeholder="Search complaints..." onkeyup="filterComplaints()">
          <button class="btn btn-primary" onclick="filterComplaints()">
            <i class="fas fa-search"></i> Search
          </button>
        </div>
        <div class="filters">
          <select id="complaintStatusFilter" class="filter-select" onchange="filterComplaints()">
            <option value="">All Status</option>
            <option value="pending">Pending</option>
            <option value="reviewed">Reviewed</option>
            <option value="resolved">Resolved</option>
          </select>
        </div>
      </div>

      <div class="complaints-list" id="complaintsList">
        <div class="loading">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Loading complaints...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Modals -->
  <div class="modal" id="actionModal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="actionModalTitle">Admin Action</div>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label id="actionModalMessage">Are you sure you want to perform this action?</label>
          <textarea id="actionReason" class="form-control" placeholder="Please provide a reason for this action..." style="display: none;"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeActionModal()">Cancel</button>
        <button class="btn" id="confirmActionBtn">Confirm</button>
      </div>
    </div>
  </div>

  <!-- NEW: User Details Modal -->
  <div class="modal" id="userDetailsModal" style="display: none;">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <div class="modal-title" id="userDetailsTitle">User Details</div>
        <button class="btn btn-outline" onclick="closeUserDetailsModal()" style="margin: 0;">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body" id="userDetailsBody">
        <!-- User details will be loaded here -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeUserDetailsModal()">Close</button>
        <button class="btn btn-primary" id="userDetailsActionBtn" style="display: none;">Take Action</button>
      </div>
    </div>
  </div>

  <!-- NEW: Complaint Details Modal -->
  <div class="modal" id="complaintDetailsModal" style="display: none;">
    <div class="modal-content modal-xl">
      <div class="modal-header">
        <div class="modal-title" id="complaintDetailsTitle">Complaint Details</div>
        <button class="btn btn-outline" onclick="closeComplaintDetailsModal()" style="margin: 0;">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body" id="complaintDetailsBody">
        <!-- Complaint details will be loaded here -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeComplaintDetailsModal()">Close</button>
        <button class="btn btn-primary" id="complaintActionBtn" style="display: none;">Update Status</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore-compat.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBLyFEpT7g4h1w9q20AjDF65TCZHV8kwfo",
      authDomain: "career-connect-d84da.firebaseapp.com",
      projectId: "career-connect-d84da",
      storageBucket: "career-connect-d84da.firebasestorage.app",
      messagingSenderId: "663938489307",
      appId: "1:663938489307:web:21db9f2c173887d5d7e5fe",
    };

    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Global variables
    let currentAdmin = null;
    let allUsers = [];
    let allComplaints = [];
    let currentAction = null;
    let currentTargetUser = null;

    // Helper function to get full image URL
    function getFullImageUrl(url) {
      if (!url) return '';
      if (url.startsWith('http')) return url;
      if (url.startsWith('/')) return 'https://brightboard.academy' + url;
      return url;
    }

    // Helper function to generate a color from a name
    function getColorFromName(name) {
      let hash = 0;
      for (let i = 0; i < name.length; i++) {
        hash = name.charCodeAt(i) + ((hash << 5) - hash);
      }
      let color = (hash & 0x00FFFFFF).toString(16).toUpperCase();
      return "00000".substring(0, 6 - color.length) + color;
    }

    // Admin login function
    async function adminLogin() {
      const email = document.getElementById('adminEmail').value;
      const password = document.getElementById('adminPassword').value;
      const errorDiv = document.getElementById('loginError');

      if (!email || !password) {
        errorDiv.textContent = 'Please enter both email and password';
        errorDiv.style.display = 'block';
        return;
      }

      try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        // Check if user is admin
        const adminDoc = await db.collection('admins').doc(user.uid).get();
        
        if (adminDoc.exists) {
          currentAdmin = adminDoc.data();
          showAdminPanel();
        } else {
          errorDiv.textContent = 'Access denied. User is not an admin.';
          errorDiv.style.display = 'block';
          await auth.signOut();
        }
      } catch (error) {
        console.error('Login error:', error);
        errorDiv.textContent = 'Invalid email or password';
        errorDiv.style.display = 'block';
      }
    }

    // Show admin panel after successful login
    function showAdminPanel() {
      document.getElementById('loginContainer').style.display = 'none';
      document.getElementById('adminHeader').style.display = 'flex';
      document.getElementById('mainAdminContainer').style.display = 'block';
      
      document.getElementById('adminWelcome').textContent = `Welcome, ${currentAdmin.name || auth.currentUser.email}`;
      
      // Load admin data
      loadUsers();
      loadComplaints();
    }

    // Check if user is already logged in
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        try {
          const adminDoc = await db.collection('admins').doc(user.uid).get();
          if (adminDoc.exists) {
            currentAdmin = adminDoc.data();
            showAdminPanel();
          } else {
            // User is not admin, show login form
            await auth.signOut();
          }
        } catch (error) {
          console.error('Error checking admin status:', error);
        }
      }
    });

    // Logout function
    function logout() {
      auth.signOut().then(() => {
        // Reset UI to login state
        document.getElementById('loginContainer').style.display = 'block';
        document.getElementById('adminHeader').style.display = 'none';
        document.getElementById('mainAdminContainer').style.display = 'none';
        document.getElementById('adminEmail').value = '';
        document.getElementById('adminPassword').value = '';
        document.getElementById('loginError').style.display = 'none';
        currentAdmin = null;
      });
    }

    // Tab navigation
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName + 'Section').classList.add('active');
    }

    // Load all users
    async function loadUsers() {
      try {
        const snapshot = await db.collection('users').get();
        allUsers = [];
        
        snapshot.forEach(doc => {
          const user = doc.data();
          user.uid = doc.id;
          allUsers.push(user);
        });

        displayUsers(allUsers);
      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersList').innerHTML = '<div class="empty-state"><p>Error loading users</p></div>';
      }
    }

    // Display users
    function displayUsers(users) {
      const usersList = document.getElementById('usersList');
      
      if (users.length === 0) {
        usersList.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-users"></i>
            <h3>No users found</h3>
            <p>Try adjusting your search criteria</p>
          </div>
        `;
        return;
      }

      usersList.innerHTML = '';
      
      users.forEach(user => {
        const userCard = createUserCard(user);
        usersList.appendChild(userCard);
      });
    }

    // Create user card
    function createUserCard(user) {
      const card = document.createElement('div');
      card.className = 'user-card';
      
      const status = user.accountStatus || 'active';
      const statusClass = `status-${status}`;
      const statusText = status.charAt(0).toUpperCase() + status.slice(1);
      
      const jobsCompleted = user.jobsCompleted || 0;
      const rating = user.rating || 0;
      
      card.innerHTML = `
        <div class="user-header">
          <div class="user-info">
            <div class="user-avatar">
              ${user.profilePhotoURL ? 
                `<img src="${getFullImageUrl(user.profilePhotoURL)}" alt="${user.fullName}" onerror="this.style.display='none'">` :
                user.fullName ? user.fullName.charAt(0).toUpperCase() : 'U'
              }
            </div>
            <div class="user-details">
              <h3>${user.fullName || 'Unknown User'}</h3>
              <p>${user.email}</p>
              <p>${user.accountType === 'professional' ? 'Professional' : 'Normal User'} â€¢ ${user.phone || 'No phone'}</p>
              <span class="user-status ${statusClass}">${statusText}</span>
            </div>
          </div>
          <div class="user-actions">
            ${status === 'active' ? `
              <button class="btn btn-warning" onclick="suspendUser('${user.uid}', '${user.fullName}')">
                <i class="fas fa-pause"></i> Suspend
              </button>
            ` : status === 'suspended' ? `
              <button class="btn btn-secondary" onclick="unsuspendUser('${user.uid}', '${user.fullName}')">
                <i class="fas fa-play"></i> Unsuspend
              </button>
            ` : ''}
            <button class="btn btn-danger" onclick="deleteUser('${user.uid}', '${user.fullName}')">
              <i class="fas fa-trash"></i> Delete
            </button>
            ${user.accountType === 'professional' ? `
              <button class="btn btn-primary" onclick="viewUserDetails('${user.uid}')">
                <i class="fas fa-eye"></i> View
              </button>
            ` : ''}
          </div>
        </div>
        ${user.accountType === 'professional' ? `
          <div class="user-stats">
            <div class="stat">
              <div class="stat-value">${jobsCompleted}</div>
              <div class="stat-label">Jobs Completed</div>
            </div>
            <div class="stat">
              <div class="stat-value">${rating}</div>
              <div class="stat-label">Rating</div>
            </div>
            <div class="stat">
              <div class="stat-value">${user.city || 'N/A'}</div>
              <div class="stat-label">City</div>
            </div>
            <div class="stat">
              <div class="stat-value">${user.area || 'N/A'}</div>
              <div class="stat-label">Area</div>
            </div>
          </div>
        ` : ''}
      `;
      
      return card;
    }

    // Load complaints
    async function loadComplaints() {
      try {
        const snapshot = await db.collection('complaints')
          .orderBy('createdAt', 'desc')
          .get();
        
        allComplaints = [];
        let pendingCount = 0;
        
        snapshot.forEach(doc => {
          const complaint = doc.data();
          complaint.id = doc.id;
          allComplaints.push(complaint);
          
          if (complaint.status === 'pending') {
            pendingCount++;
          }
        });

        // Update pending complaints badge
        const badge = document.getElementById('pendingComplaintsBadge');
        if (pendingCount > 0) {
          badge.textContent = pendingCount;
          badge.style.display = 'inline';
        } else {
          badge.style.display = 'none';
        }

        displayComplaints(allComplaints);
      } catch (error) {
        console.error('Error loading complaints:', error);
        document.getElementById('complaintsList').innerHTML = '<div class="empty-state"><p>Error loading complaints</p></div>';
      }
    }

    // Display complaints
    function displayComplaints(complaints) {
      const complaintsList = document.getElementById('complaintsList');
      
      if (complaints.length === 0) {
        complaintsList.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-flag"></i>
            <h3>No complaints found</h3>
            <p>All complaints have been resolved</p>
          </div>
        `;
        return;
      }

      complaintsList.innerHTML = '';
      
      complaints.forEach(complaint => {
        const complaintCard = createComplaintCard(complaint);
        complaintsList.appendChild(complaintCard);
      });
    }

    // Create complaint card
    function createComplaintCard(complaint) {
      const card = document.createElement('div');
      card.className = 'complaint-card';
      
      const statusClass = `status-${complaint.status}`;
      const date = complaint.createdAt ? complaint.createdAt.toDate().toLocaleDateString() : 'Unknown date';
      
      card.innerHTML = `
        <div class="complaint-header">
          <div>
            <div class="complaint-user">${complaint.userName} (${complaint.userEmail})</div>
            <div class="complaint-date">Submitted on ${date}</div>
          </div>
          <span class="complaint-status ${statusClass}">${complaint.status}</span>
        </div>
        <div class="complaint-reason">
          <strong>Reason:</strong> ${getComplaintReasonText(complaint.reason)}
        </div>
        <div class="complaint-details">
          <strong>Details:</strong> ${complaint.details}
        </div>
        ${complaint.adminReason ? `
          <div class="complaint-reason">
            <strong>Admin Reason:</strong> ${complaint.adminReason}
          </div>
        ` : ''}
        <div class="user-actions">
          ${complaint.status === 'pending' ? `
            <button class="btn btn-primary" onclick="markComplaintReviewed('${complaint.id}')">
              <i class="fas fa-check"></i> Mark Reviewed
            </button>
          ` : complaint.status === 'reviewed' ? `
            <button class="btn btn-secondary" onclick="markComplaintResolved('${complaint.id}')">
              <i class="fas fa-check-double"></i> Mark Resolved
            </button>
          ` : ''}
          <button class="btn btn-outline" onclick="viewComplaintDetails('${complaint.id}')">
            <i class="fas fa-eye"></i> View Details
          </button>
        </div>
      `;
      
      return card;
    }

    // Get complaint reason text
    function getComplaintReasonText(reason) {
      const reasons = {
        'wrongful_suspension': 'Wrongful Suspension',
        'wrongful_deletion': 'Wrongful Account Deletion',
        'unfair_reason': 'Unfair Reason Provided',
        'other': 'Other'
      };
      return reasons[reason] || reason;
    }

    // User actions
    function suspendUser(uid, userName) {
      currentAction = 'suspend';
      currentTargetUser = { uid, userName };
      
      document.getElementById('actionModalTitle').textContent = 'Suspend User';
      document.getElementById('actionModalMessage').textContent = `Are you sure you want to suspend ${userName}?`;
      document.getElementById('actionReason').style.display = 'block';
      document.getElementById('confirmActionBtn').className = 'btn btn-warning';
      document.getElementById('confirmActionBtn').innerHTML = '<i class="fas fa-pause"></i> Suspend User';
      document.getElementById('confirmActionBtn').onclick = confirmAction;
      
      document.getElementById('actionModal').style.display = 'flex';
    }

    function unsuspendUser(uid, userName) {
      currentAction = 'unsuspend';
      currentTargetUser = { uid, userName };
      
      document.getElementById('actionModalTitle').textContent = 'Unsuspend User';
      document.getElementById('actionModalMessage').textContent = `Are you sure you want to unsuspend ${userName}?`;
      document.getElementById('actionReason').style.display = 'none';
      document.getElementById('confirmActionBtn').className = 'btn btn-secondary';
      document.getElementById('confirmActionBtn').innerHTML = '<i class="fas fa-play"></i> Unsuspend User';
      document.getElementById('confirmActionBtn').onclick = confirmAction;
      
      document.getElementById('actionModal').style.display = 'flex';
    }

    function deleteUser(uid, userName) {
      currentAction = 'delete';
      currentTargetUser = { uid, userName };
      
      document.getElementById('actionModalTitle').textContent = 'Delete User';
      document.getElementById('actionModalMessage').textContent = `Are you sure you want to permanently delete ${userName}? This action cannot be undone.`;
      document.getElementById('actionReason').style.display = 'block';
      document.getElementById('confirmActionBtn').className = 'btn btn-danger';
      document.getElementById('confirmActionBtn').innerHTML = '<i class="fas fa-trash"></i> Delete User';
      document.getElementById('confirmActionBtn').onclick = confirmAction;
      
      document.getElementById('actionModal').style.display = 'flex';
    }

    // Confirm action
    async function confirmAction() {
      const reason = document.getElementById('actionReason').value;
      
      if ((currentAction === 'suspend' || currentAction === 'delete') && !reason) {
        alert('Please provide a reason for this action');
        return;
      }

      try {
        const updateData = {};
        
        switch (currentAction) {
          case 'suspend':
            updateData.accountStatus = 'suspended';
            updateData.suspensionReason = reason;
            updateData.suspendedAt = firebase.firestore.FieldValue.serverTimestamp();
            break;
          case 'unsuspend':
            updateData.accountStatus = 'active';
            updateData.suspensionReason = null;
            updateData.suspendedAt = null;
            break;
          case 'delete':
            updateData.accountStatus = 'deleted';
            updateData.deletionReason = reason;
            updateData.deletedAt = firebase.firestore.FieldValue.serverTimestamp();
            break;
        }

        await db.collection('users').doc(currentTargetUser.uid).update(updateData);
        
        closeActionModal();
        alert(`User ${currentTargetUser.userName} has been ${currentAction}ed successfully`);
        loadUsers();
        
      } catch (error) {
        console.error('Error performing action:', error);
        alert('Error performing action: ' + error.message);
      }
    }

    // Close action modal
    function closeActionModal() {
      document.getElementById('actionModal').style.display = 'none';
      document.getElementById('actionReason').value = '';
      currentAction = null;
      currentTargetUser = null;
    }

    // Complaint actions
    async function markComplaintReviewed(complaintId) {
      try {
        await db.collection('complaints').doc(complaintId).update({
          status: 'reviewed',
          reviewedAt: firebase.firestore.FieldValue.serverTimestamp(),
          reviewedBy: currentAdmin.name || auth.currentUser.email
        });
        
        loadComplaints();
      } catch (error) {
        console.error('Error marking complaint as reviewed:', error);
        alert('Error updating complaint: ' + error.message);
      }
    }

    async function markComplaintResolved(complaintId) {
      try {
        await db.collection('complaints').doc(complaintId).update({
          status: 'resolved',
          resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
          resolvedBy: currentAdmin.name || auth.currentUser.email
        });
        
        loadComplaints();
      } catch (error) {
        console.error('Error marking complaint as resolved:', error);
        alert('Error updating complaint: ' + error.message);
      }
    }

    // View user details - IMPLEMENTED
    async function viewUserDetails(uid) {
      try {
        console.log('Loading user details for:', uid);
        
        // Show loading state
        document.getElementById('userDetailsBody').innerHTML = `
          <div class="loading">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading user details...</p>
          </div>
        `;
        
        document.getElementById('userDetailsModal').style.display = 'flex';

        // Get user data
        const userDoc = await db.collection('users').doc(uid).get();
        
        if (!userDoc.exists) {
          document.getElementById('userDetailsBody').innerHTML = `
            <div class="empty-state">
              <i class="fas fa-user-slash"></i>
              <h3>User Not Found</h3>
              <p>The user data could not be loaded.</p>
            </div>
          `;
          return;
        }

        const user = userDoc.data();
        user.uid = uid;

        // Get additional user data (jobs, ratings, etc.)
        const [jobsSnapshot, ratingsSnapshot, favoritesSnapshot] = await Promise.all([
          db.collection('jobs')
            .where(user.accountType === 'professional' ? 'workerId' : 'clientId', '==', uid)
            .get(),
          db.collection('jobs')
            .where('workerId', '==', uid)
            .where('rated', '==', true)
            .get(),
          db.collection('users').doc(uid).collection('favorites').get()
        ]);

        // Calculate stats
        const totalJobs = jobsSnapshot.size;
        const completedJobs = jobsSnapshot.docs.filter(doc => doc.data().status === 'completed').length;
        const pendingJobs = jobsSnapshot.docs.filter(doc => doc.data().status === 'pending').length;
        const averageRating = ratingsSnapshot.size > 0 
          ? (ratingsSnapshot.docs.reduce((sum, doc) => sum + (doc.data().rating || 0), 0) / ratingsSnapshot.size).toFixed(1)
          : 'No ratings';
        const totalFavorites = favoritesSnapshot.size;

        // Get suspension/complaint history
        const complaintsSnapshot = await db.collection('complaints')
          .where('userId', '==', uid)
          .orderBy('createdAt', 'desc')
          .get();

        const complaints = complaintsSnapshot.docs.map(doc => {
          const data = doc.data();
          data.id = doc.id;
          return data;
        });

        // Format the user details HTML
        const status = user.accountStatus || 'active';
        const statusClass = `status-${status}`;
        const statusText = status.charAt(0).toUpperCase() + status.slice(1);

        let userDetailsHTML = `
          <div class="user-details-grid">
            <div class="detail-item">
              <span class="detail-label">Full Name:</span>
              <span class="detail-value">${user.fullName || 'Not provided'}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Email:</span>
              <span class="detail-value">${user.email || 'Not provided'}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Phone:</span>
              <span class="detail-value">${user.phone || 'Not provided'}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Account Type:</span>
              <span class="detail-value">${user.accountType === 'professional' ? 'Professional' : 'Normal User'}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Account Status:</span>
              <span class="detail-value user-status ${statusClass}">${statusText}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Member Since:</span>
              <span class="detail-value">${user.createdAt ? user.createdAt.toDate().toLocaleDateString() : 'Unknown'}</span>
            </div>
        `;

        if (user.accountType === 'professional') {
          userDetailsHTML += `
            <div class="detail-item">
              <span class="detail-label">Profession:</span>
              <span class="detail-value">${user.jobTitle || 'Not specified'}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Location:</span>
              <span class="detail-value">${user.area || 'N/A'}, ${user.city || 'N/A'}</span>
            </div>
          `;
        }

        userDetailsHTML += `</div>`;

        // Add user stats
        userDetailsHTML += `
          <div class="user-stats-grid">
            <div class="stat-card">
              <div class="stat-number">${totalJobs}</div>
              <div class="stat-label">Total Jobs</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">${completedJobs}</div>
              <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">${pendingJobs}</div>
              <div class="stat-label">Pending</div>
            </div>
        `;

        if (user.accountType === 'professional') {
          userDetailsHTML += `
            <div class="stat-card">
              <div class="stat-number">${averageRating}</div>
              <div class="stat-label">Average Rating</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">${ratingsSnapshot.size}</div>
              <div class="stat-label">Total Ratings</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">${user.jobsCompleted || 0}</div>
              <div class="stat-label">Jobs Completed</div>
            </div>
          `;
        } else {
          userDetailsHTML += `
            <div class="stat-card">
              <div class="stat-number">${totalFavorites}</div>
              <div class="stat-label">Favorites</div>
            </div>
          `;
        }

        userDetailsHTML += `</div>`;

        // Add suspension/deletion reason if applicable
        if (user.suspensionReason) {
          userDetailsHTML += `
            <div class="full-description">
              <h4>Suspension Reason</h4>
              <p>${user.suspensionReason}</p>
              <small>Suspended on: ${user.suspendedAt ? user.suspendedAt.toDate().toLocaleDateString() : 'Unknown date'}</small>
            </div>
          `;
        }

        if (user.deletionReason) {
          userDetailsHTML += `
            <div class="full-description">
              <h4>Deletion Reason</h4>
              <p>${user.deletionReason}</p>
              <small>Deleted on: ${user.deletedAt ? user.deletedAt.toDate().toLocaleDateString() : 'Unknown date'}</small>
            </div>
          `;
        }

        // Add complaint history
        if (complaints.length > 0) {
          userDetailsHTML += `
            <div class="action-history">
              <h4>Complaint History (${complaints.length})</h4>
              ${complaints.map(complaint => `
                <div class="history-item">
                  <strong>${getComplaintReasonText(complaint.reason)}</strong> - 
                  <span class="complaint-status status-${complaint.status}">${complaint.status}</span>
                  <br>
                  <small>Submitted: ${complaint.createdAt ? complaint.createdAt.toDate().toLocaleDateString() : 'Unknown date'}</small>
                  ${complaint.adminReason ? `<br><small><strong>Admin Response:</strong> ${complaint.adminReason}</small>` : ''}
                </div>
              `).join('')}
            </div>
          `;
        }

        // Add professional description if available
        if (user.jobDescription) {
          userDetailsHTML += `
            <div class="full-description">
              <h4>Professional Description</h4>
              <p>${user.jobDescription}</p>
            </div>
          `;
        }

        document.getElementById('userDetailsBody').innerHTML = userDetailsHTML;
        document.getElementById('userDetailsTitle').textContent = `User Details: ${user.fullName || 'Unknown User'}`;

        // Set up action button based on current status
        const actionBtn = document.getElementById('userDetailsActionBtn');
        actionBtn.style.display = 'block';
        
        if (status === 'active') {
          actionBtn.className = 'btn btn-warning';
          actionBtn.innerHTML = '<i class="fas fa-pause"></i> Suspend User';
          actionBtn.onclick = () => suspendUser(uid, user.fullName);
        } else if (status === 'suspended') {
          actionBtn.className = 'btn btn-secondary';
          actionBtn.innerHTML = '<i class="fas fa-play"></i> Unsuspend User';
          actionBtn.onclick = () => unsuspendUser(uid, user.fullName);
        } else {
          actionBtn.style.display = 'none';
        }

      } catch (error) {
        console.error('Error loading user details:', error);
        document.getElementById('userDetailsBody').innerHTML = `
          <div class="empty-state">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Error Loading Details</h3>
            <p>${error.message}</p>
          </div>
        `;
      }
    }

    // View complaint details - IMPLEMENTED
    async function viewComplaintDetails(complaintId) {
      try {
        console.log('Loading complaint details for:', complaintId);
        
        // Show loading state
        document.getElementById('complaintDetailsBody').innerHTML = `
          <div class="loading">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading complaint details...</p>
          </div>
        `;
        
        document.getElementById('complaintDetailsModal').style.display = 'flex';

        // Get complaint data
        const complaintDoc = await db.collection('complaints').doc(complaintId).get();
        
        if (!complaintDoc.exists) {
          document.getElementById('complaintDetailsBody').innerHTML = `
            <div class="empty-state">
              <i class="fas fa-flag"></i>
              <h3>Complaint Not Found</h3>
              <p>The complaint data could not be loaded.</p>
            </div>
          `;
          return;
        }

        const complaint = complaintDoc.data();
        complaint.id = complaintId;

        // Get user data for the complaint
        const userDoc = await db.collection('users').doc(complaint.userId).get();
        const userData = userDoc.exists ? userDoc.data() : null;

        // Format the complaint details HTML
        const statusClass = `status-${complaint.status}`;
        const date = complaint.createdAt ? complaint.createdAt.toDate() : new Date();
        
        let complaintHTML = `
          <div class="user-details-grid">
            <div class="detail-item">
              <span class="detail-label">Complaint ID:</span>
              <span class="detail-value">${complaintId}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Status:</span>
              <span class="detail-value complaint-status ${statusClass}">${complaint.status}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Submitted:</span>
              <span class="detail-value">${date.toLocaleDateString()} at ${date.toLocaleTimeString()}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">User Type:</span>
              <span class="detail-value">${complaint.userType === 'professional' ? 'Professional' : 'Normal User'}</span>
            </div>
          </div>

          <div class="user-details-grid">
            <div class="detail-item">
              <span class="detail-label">User Name:</span>
              <span class="detail-value">${complaint.userName || 'Unknown'}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">User Email:</span>
              <span class="detail-value">${complaint.userEmail || 'Not provided'}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">User ID:</span>
              <span class="detail-value">${complaint.userId}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Account Status:</span>
              <span class="detail-value user-status status-${complaint.accountStatus}">${complaint.accountStatus}</span>
            </div>
          </div>

          <div class="full-description">
            <h4>Complaint Reason</h4>
            <p><strong>${getComplaintReasonText(complaint.reason)}</strong></p>
          </div>

          <div class="full-description">
            <h4>User's Detailed Explanation</h4>
            <p>${complaint.details || 'No additional details provided.'}</p>
          </div>
        `;

        // Add admin reason if available
        if (complaint.adminReason) {
          complaintHTML += `
            <div class="full-description">
              <h4>Admin Response</h4>
              <p>${complaint.adminReason}</p>
            </div>
          `;
        }

        // Add timeline
        complaintHTML += `
          <div class="complaint-timeline">
            <h4>Complaint Timeline</h4>
            <div class="timeline-item">
              <div class="timeline-icon">
                <i class="fas fa-flag"></i>
              </div>
              <div class="timeline-content">
                <div class="timeline-date">${date.toLocaleDateString()}</div>
                <div class="timeline-text">
                  <strong>Complaint Submitted</strong><br>
                  User filed a complaint regarding ${getComplaintReasonText(complaint.reason).toLowerCase()}
                </div>
              </div>
            </div>
        `;

        if (complaint.reviewedAt) {
          const reviewedDate = complaint.reviewedAt.toDate();
          complaintHTML += `
            <div class="timeline-item">
              <div class="timeline-icon">
                <i class="fas fa-eye"></i>
              </div>
              <div class="timeline-content">
                <div class="timeline-date">${reviewedDate.toLocaleDateString()}</div>
                <div class="timeline-text">
                  <strong>Marked as Reviewed</strong><br>
                  Reviewed by: ${complaint.reviewedBy || 'Unknown admin'}
                </div>
              </div>
            </div>
          `;
        }

        if (complaint.resolvedAt) {
          const resolvedDate = complaint.resolvedAt.toDate();
          complaintHTML += `
            <div class="timeline-item">
              <div class="timeline-icon">
                <i class="fas fa-check-circle"></i>
              </div>
              <div class="timeline-content">
                <div class="timeline-date">${resolvedDate.toLocaleDateString()}</div>
                <div class="timeline-text">
                  <strong>Marked as Resolved</strong><br>
                  Resolved by: ${complaint.resolvedBy || 'Unknown admin'}
                </div>
              </div>
            </div>
          `;
        }

        complaintHTML += `</div>`;

        // Add user account details if available
        if (userData) {
          complaintHTML += `
            <div class="full-description">
              <h4>User Account Information</h4>
              <div class="user-details-grid">
                <div class="detail-item">
                  <span class="detail-label">Full Name:</span>
                  <span class="detail-value">${userData.fullName || 'Not provided'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Phone:</span>
                  <span class="detail-value">${userData.phone || 'Not provided'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">City:</span>
                  <span class="detail-value">${userData.city || 'Not provided'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Area:</span>
                  <span class="detail-value">${userData.area || 'Not provided'}</span>
                </div>
              </div>
              ${userData.accountType === 'professional' ? `
                <div class="user-details-grid">
                  <div class="detail-item">
                    <span class="detail-label">Profession:</span>
                    <span class="detail-value">${userData.jobTitle || 'Not specified'}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Jobs Completed:</span>
                    <span class="detail-value">${userData.jobsCompleted || 0}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Rating:</span>
                    <span class="detail-value">${userData.rating || 'No ratings'}</span>
                  </div>
                </div>
              ` : ''}
            </div>
          `;
        }

        document.getElementById('complaintDetailsBody').innerHTML = complaintHTML;
        document.getElementById('complaintDetailsTitle').textContent = `Complaint Details: ${getComplaintReasonText(complaint.reason)}`;

        // Set up action button based on current status
        const actionBtn = document.getElementById('complaintActionBtn');
        actionBtn.style.display = 'block';
        
        if (complaint.status === 'pending') {
          actionBtn.className = 'btn btn-primary';
          actionBtn.innerHTML = '<i class="fas fa-check"></i> Mark as Reviewed';
          actionBtn.onclick = () => {
            markComplaintReviewed(complaintId);
            closeComplaintDetailsModal();
          };
        } else if (complaint.status === 'reviewed') {
          actionBtn.className = 'btn btn-secondary';
          actionBtn.innerHTML = '<i class="fas fa-check-double"></i> Mark as Resolved';
          actionBtn.onclick = () => {
            markComplaintResolved(complaintId);
            closeComplaintDetailsModal();
          };
        } else {
          actionBtn.style.display = 'none';
        }

      } catch (error) {
        console.error('Error loading complaint details:', error);
        document.getElementById('complaintDetailsBody').innerHTML = `
          <div class="empty-state">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Error Loading Details</h3>
            <p>${error.message}</p>
          </div>
        `;
      }
    }

    // Close user details modal
    function closeUserDetailsModal() {
      document.getElementById('userDetailsModal').style.display = 'none';
      document.getElementById('userDetailsActionBtn').style.display = 'none';
    }

    // Close complaint details modal
    function closeComplaintDetailsModal() {
      document.getElementById('complaintDetailsModal').style.display = 'none';
      document.getElementById('complaintActionBtn').style.display = 'none';
    }

    // Filter functions
    function filterUsers() {
      const searchTerm = document.getElementById('userSearch').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      const typeFilter = document.getElementById('typeFilter').value;
      
      const filteredUsers = allUsers.filter(user => {
        const matchesSearch = !searchTerm || 
          (user.fullName && user.fullName.toLowerCase().includes(searchTerm)) ||
          (user.email && user.email.toLowerCase().includes(searchTerm)) ||
          (user.jobTitle && user.jobTitle.toLowerCase().includes(searchTerm));
        
        const matchesStatus = !statusFilter || (user.accountStatus || 'active') === statusFilter;
        const matchesType = !typeFilter || user.accountType === typeFilter;
        
        return matchesSearch && matchesStatus && matchesType;
      });
      
      displayUsers(filteredUsers);
    }

    function filterComplaints() {
      const searchTerm = document.getElementById('complaintSearch').value.toLowerCase();
      const statusFilter = document.getElementById('complaintStatusFilter').value;
      
      const filteredComplaints = allComplaints.filter(complaint => {
        const matchesSearch = !searchTerm || 
          (complaint.userName && complaint.userName.toLowerCase().includes(searchTerm)) ||
          (complaint.userEmail && complaint.userEmail.toLowerCase().includes(searchTerm)) ||
          (complaint.details && complaint.details.toLowerCase().includes(searchTerm));
        
        const matchesStatus = !statusFilter || complaint.status === statusFilter;
        
        return matchesSearch && matchesStatus;
      });
      
      displayComplaints(filteredComplaints);
    }

    // Handle Enter key in login form
    document.getElementById('adminPassword').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        adminLogin();
      }
    });
  </script>
</body>
</html>
