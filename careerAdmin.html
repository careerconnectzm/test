<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CareerConnect - Find Local Professionals</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Previous CSS styles remain the same, just removing the admin panel button styles */
    :root {
      --primary-color: #1877f2;
      --secondary-color: #42b72a;
      --bg-color: #f0f2f5;
      --card-bg: #ffffff;
      --text-primary: #050505;
      --text-secondary: #65676b;
      --divider: #e4e6eb;
      --hover-bg: #f2f2f2;
      --shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.1);
      --radius: 12px;
      --radius-lg: 16px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-color);
      color: var(--text-primary);
      line-height: 1.5;
    }

    /* Header/Navigation */
    header {
      background: var(--card-bg);
      box-shadow: var(--shadow);
      padding: 0 16px;
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      height: 56px;
    }

    .header-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
    }

    .logo {
      display: flex;
      align-items: center;
      color: var(--primary-color);
      font-weight: bold;
      font-size: 24px;
      text-decoration: none;
    }

    .logo i {
      margin-right: 8px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: pointer;
      overflow: hidden;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Main Layout */
    .main-container {
      display: flex;
      max-width: 1200px;
      margin: 20px auto;
      gap: 20px;
      padding: 0 16px;
    }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card-bg);
      display: flex;
      justify-content: space-around;
      padding: 8px 0;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      color: var(--text-secondary);
      flex: 1;
      max-width: 100px;
      transition: all 0.2s ease;
    }

    .nav-item.active {
      color: var(--primary-color);
      background: rgba(24, 119, 242, 0.1);
    }

    .nav-item:hover {
      background: var(--hover-bg);
    }

    .nav-item i {
      font-size: 20px;
      margin-bottom: 4px;
    }

    .nav-item span {
      font-size: 12px;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      max-width: 680px;
      margin-bottom: 70px;
    }

    /* Search Bar */
    .search-container {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
    }

    .search-box {
      display: flex;
      gap: 12px;
    }

    .search-box input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 20px;
      border: 1px solid var(--divider);
      background: var(--bg-color);
      font-size: 16px;
    }

    .search-box button {
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 20px;
      padding: 0 20px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .search-box button:hover {
      background: #0e6ce0;
    }

    /* Worker List */
    .workers-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* Worker Card - Small Layout */
    .worker-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      display: flex;
      gap: 16px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      position: relative;
    }

    .worker-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .worker-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      overflow: hidden;
      flex-shrink: 0;
    }

    .worker-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .worker-info {
      flex: 1;
    }

    .worker-name {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 4px;
    }

    .worker-job {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 4px;
    }

    .worker-location {
      color: var(--text-secondary);
      font-size: 12px;
      margin-bottom: 8px;
    }

    .worker-rating {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 14px;
    }

    .worker-rating i {
      color: #f7b928;
    }

    /* Favorite Button */
    .favorite-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: #ddd;
      transition: color 0.2s ease;
      z-index: 10;
    }

    .favorite-btn:hover {
      color: #f7b928;
    }

    .favorite-btn.active {
      color: #f7b928;
    }

    /* Worker Profile - Big Layout */
    .worker-profile {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
      position: relative;
    }

    .profile-header {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
      position: relative;
    }

    .profile-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      overflow: hidden;
      flex-shrink: 0;
    }

    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-details {
      flex: 1;
    }

    .profile-name {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 8px;
    }

    .profile-job {
      font-size: 18px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .profile-location {
      font-size: 16px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .profile-stats {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
    }

    .stat {
      text-align: center;
    }

    .stat-value {
      font-size: 18px;
      font-weight: bold;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .profile-description {
      margin-bottom: 16px;
      line-height: 1.6;
    }

    .profile-actions {
      display: flex;
      gap: 12px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      flex: 1;
      text-align: center;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: #0e6ce0;
    }

    .btn-secondary {
      background: var(--secondary-color);
      color: white;
    }

    .btn-secondary:hover {
      background: #36a420;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--divider);
      color: var(--text-primary);
    }

    .btn-outline:hover {
      background: var(--hover-bg);
    }

    /* Orders Section */
    .orders-tabs {
      display: flex;
      border-bottom: 1px solid var(--divider);
      margin-bottom: 16px;
    }

    .tab {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s ease;
    }

    .tab.active {
      border-bottom-color: var(--primary-color);
      color: var(--primary-color);
      font-weight: bold;
    }

    .tab:hover {
      background: var(--hover-bg);
      border-radius: 4px 4px 0 0;
    }

    .order-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .order-card:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .order-status {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-accepted {
      background: #d1ecf1;
      color: #0c5460;
    }

    .status-completed {
      background: #d4edda;
      color: #155724;
    }

    .status-rejected {
      background: #f8d7da;
      color: #721c24;
    }

    .order-worker {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .order-worker-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
    }

    .order-worker-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .order-details {
      margin-bottom: 12px;
    }

    .order-actions {
      display: flex;
      gap: 8px;
    }

    /* Account Section */
    .account-section {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
    }

    .account-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
    }

    .account-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      overflow: hidden;
    }

    .account-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .account-info h2 {
      margin-bottom: 4px;
    }

    .account-info p {
      color: var(--text-secondary);
    }

    .account-details {
      margin-top: 16px;
    }

    .detail-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--divider);
      transition: background 0.2s ease;
    }

    .detail-item:hover {
      background: var(--hover-bg);
      border-radius: 4px;
    }

    .detail-item:last-child {
      border-bottom: none;
    }

    /* Auth Container */
    .auth-container {
      max-width: 400px;
      margin: 60px auto;
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow-lg);
    }

    .auth-header {
      text-align: center;
      margin-bottom: 24px;
    }

    .auth-header h1 {
      color: var(--primary-color);
      font-size: 28px;
      margin-bottom: 8px;
    }

    .auth-header p {
      color: var(--text-secondary);
    }

    .auth-form input, .auth-form select, .auth-form textarea {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 16px;
      border: 1px solid var(--divider);
      border-radius: 6px;
      font-size: 16px;
      font-family: inherit;
    }

    .auth-form input:focus, .auth-form select:focus, .auth-form textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(24, 119, 242, 0.2);
    }

    .account-type-selector {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }

    .account-type {
      flex: 1;
      text-align: center;
      padding: 12px;
      border: 2px solid var(--divider);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .account-type.selected {
      border-color: var(--primary-color);
      background: rgba(24, 119, 242, 0.1);
    }

    .account-type:hover {
      background: var(--hover-bg);
    }

    .auth-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }

    .btn {
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      text-align: center;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: #0e6ce0;
    }

    .btn-secondary {
      background: var(--secondary-color);
      color: white;
    }

    .btn-secondary:hover {
      background: #36a420;
    }

    .job-details-container {
      max-width: 500px;
      margin: 60px auto;
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow-lg);
    }

    /* Chat Modal */
    .chat-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .chat-container {
      background: white;
      border-radius: var(--radius);
      width: 100%;
      max-width: 500px;
      height: 80%;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-lg);
    }

    .chat-header {
      padding: 16px;
      border-bottom: 1px solid var(--divider);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
    }

    .message {
      margin-bottom: 16px;
      display: flex;
    }

    .message.sent {
      justify-content: flex-end;
    }

    .message-content {
      max-width: 70%;
      padding: 12px;
      border-radius: 18px;
    }

    .message.received .message-content {
      background: var(--bg-color);
    }

    .message.sent .message-content {
      background: var(--primary-color);
      color: white;
    }

    .chat-input {
      padding: 16px;
      border-top: 1px solid var(--divider);
      display: flex;
      gap: 12px;
    }

    .chat-input input {
      flex: 1;
      padding: 12px;
      border: 1px solid var(--divider);
      border-radius: 20px;
    }

    .chat-input button {
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 20px;
      padding: 0 20px;
      cursor: pointer;
    }

    /* Chat Booking Section */
    .chat-booking-section {
      padding: 16px;
      border-top: 1px solid var(--divider);
      background: var(--bg-color);
    }

    .booking-actions {
      display: flex;
      gap: 12px;
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-content {
      background: white;
      border-radius: var(--radius);
      width: 100%;
      max-width: 500px;
      padding: 24px;
      box-shadow: var(--shadow-lg);
    }

    .modal-header {
      margin-bottom: 16px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 8px;
    }

    .modal-body {
      margin-bottom: 24px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .form-control {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--divider);
      border-radius: 6px;
      font-size: 16px;
      font-family: inherit;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(24, 119, 242, 0.2);
    }

    .modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    /* Rating Stars */
    .rating-stars {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin: 16px 0;
    }

    .rating-star {
      font-size: 32px;
      color: #ddd;
      cursor: pointer;
      transition: color 0.2s ease;
    }

    .rating-star.active {
      color: #f7b928;
    }

    /* NEW: Search Page Styles */
    .search-page {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--card-bg);
      z-index: 1000;
      display: none;
      flex-direction: column;
    }

    .search-page-header {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid var(--divider);
      background: var(--card-bg);
    }

    .search-page-back {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: var(--text-primary);
      margin-right: 12px;
    }

    .search-page-input {
      flex: 1;
      padding: 10px 16px;
      border-radius: 20px;
      border: 1px solid var(--divider);
      background: var(--bg-color);
      font-size: 16px;
    }

    .search-page-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .search-filters {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
    }

    .filter-section {
      margin-bottom: 16px;
    }

    .filter-title {
      font-weight: bold;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .filter-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .filter-option {
      padding: 6px 12px;
      border: 1px solid var(--divider);
      border-radius: 16px;
      background: var(--bg-color);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .filter-option.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .search-results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .sort-options {
      position: relative;
    }

    .sort-button {
      background: none;
      border: 1px solid var(--divider);
      border-radius: 6px;
      padding: 6px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .sort-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      padding: 8px 0;
      min-width: 150px;
      z-index: 10;
      display: none;
    }

    .sort-dropdown.show {
      display: block;
    }

    .sort-option {
      padding: 8px 16px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .sort-option:hover {
      background: var(--hover-bg);
    }

    /* NEW: Search Page Worker Profile */
    .search-page-worker-profile {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
      position: relative;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .main-container {
        flex-direction: column;
        padding: 0 8px;
      }
      
      .worker-card, .worker-profile, .order-card, .account-section {
        padding: 12px;
      }
      
      .profile-actions {
        flex-direction: column;
      }
      
      .modal {
        padding: 10px;
      }
      
      .modal-content {
        padding: 16px;
      }
    }
    
    /* Account Suspended/Deleted Message */
    .account-status-message {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
      color: #856404;
    }

    .account-status-message h3 {
      color: #856404;
      margin-bottom: 8px;
    }

    .complaint-btn {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
      cursor: pointer;
      margin-top: 12px;
      font-weight: bold;
    }

    .complaint-btn:hover {
      background: #c82333;
    }
    
  </style>
</head>
<body>
  <!-- Header/Navigation -->
  <header id="mainHeader" style="display: none;">
    <div class="header-container">
      <a href="#" class="logo">
        <i class="fas fa-briefcase"></i>
        CareerConnect
      </a>
      
      <div class="user-avatar" id="headerUserAvatar">
        <img id="headerUserAvatarImg" src="" alt="User Avatar">
      </div>
    </div>
  </header>

  <!-- NEW: Search Page -->
  <div class="search-page" id="searchPage">
    <div class="search-page-header">
      <button class="search-page-back" onclick="closeSearchPage()">
        <i class="fas fa-arrow-left"></i>
      </button>
      <input type="text" class="search-page-input" id="searchPageInput" placeholder="Search for professionals or services..." onkeypress="handleSearchPageKeypress(event)">
      <button onclick="executeSearch()" style="background: none; border: none; margin-left: 12px; cursor: pointer;">
        <i class="fas fa-search"></i>
      </button>
    </div>
    
    <div class="search-page-content">
      <div class="search-filters">
        <div class="filter-section">
          <div class="filter-title">
            <span>Rating</span>
          </div>
          <div class="filter-options">
            <div class="filter-option" data-filter="rating" data-value="4" onclick="toggleFilter(this)">4★ & above</div>
            <div class="filter-option" data-filter="rating" data-value="3" onclick="toggleFilter(this)">3★ & above</div>
            <div class="filter-option" data-filter="rating" data-value="2" onclick="toggleFilter(this)">2★ & above</div>
            <div class="filter-option" data-filter="rating" data-value="1" onclick="toggleFilter(this)">1★ & above</div>
          </div>
        </div>
        
        <!-- Additional filter sections can be added here later -->
      </div>
      
      <div class="search-results-header">
        <div class="search-results-count" id="searchResultsCount">0 results</div>
        <div class="sort-options">
          <button class="sort-button" onclick="toggleSortDropdown()">
            Sort by <i class="fas fa-chevron-down"></i>
          </button>
          <div class="sort-dropdown" id="sortDropdown">
            <div class="sort-option" data-sort="rating" onclick="sortResults('rating')">Highest Rated</div>
            <div class="sort-option" data-sort="jobs" onclick="sortResults('jobs')">Most Jobs</div>
            <div class="sort-option" data-sort="name" onclick="sortResults('name')">Name (A-Z)</div>
          </div>
        </div>
      </div>
      
      <!-- Search Results List -->
      <div class="workers-list" id="searchResultsList">
        <!-- Search results will be loaded here -->
      </div>
      
      <!-- Search Page Worker Profile View (hidden by default) -->
      <div id="searchPageWorkerProfile" style="display: none;">
        <!-- Worker profile will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Auth Section -->
  <div class="auth-container" id="authSection">
    <div class="auth-header">
      <h1>CareerConnect</h1>
      <p>Find local professionals or get hired</p>
    </div>
    
    <div class="auth-form">
      <div class="account-type-selector">
        <div class="account-type selected" id="normalAccountType" onclick="selectAccountType('normal')">
          <i class="fas fa-user"></i>
          <div>Normal User</div>
        </div>
        <div class="account-type" id="professionalAccountType" onclick="selectAccountType('professional')">
          <i class="fas fa-tools"></i>
          <div>Professional</div>
        </div>
      </div>
      
      <input type="text" id="fullName" placeholder="Full Name">
      <input type="email" id="email" placeholder="Email">
      <input type="tel" id="phone" placeholder="Phone Number">
      <select id="city" style="display: none;">
        <option value="">Select City</option>
        <option value="Lusaka">Lusaka</option>
      </select>
      <select id="area" style="display: none;">
        <option value="">Select Area</option>
        
    <option value="Avondale">Avondale</option>
    <option value="Bauleni">Bauleni</option>
    <option value="Central Business District">Central Business District</option>
    <option value="Chaisa">Chaisa</option>
    <option value="Chainda">Chainda</option>
    <option value="Chamba Valley">Chamba Valley</option>
    <option value="Chawama">Chawama</option>
    <option value="Chelstone">Chelstone</option>
    <option value="Chilenje">Chilenje</option>
    <option value="Chilanga">Chilanga</option>
    <option value="Chipata Compound">Chipata Compound</option>
    <option value="Chudleigh">Chudleigh</option>
    <option value="Emmasdale">Emmasdale</option>
    <option value="Fairview">Fairview</option>
    <option value="Garden Compound">Garden Compound</option>
    <option value="George Compound">George Compound</option>
    <option value="Ibex Hill">Ibex Hill</option>
    <option value="Industrial Area">Industrial Area</option>
    <option value="Jack Compound">Jack Compound</option>
    <option value="John Laing">John Laing</option>
    <option value="Kabwata">Kabwata</option>
    <option value="Kabulonga">Kabulonga</option>
    <option value="Kalingalinga">Kalingalinga</option>
    <option value="Kalundu">Kalundu</option>
    <option value="Kamwala">Kamwala</option>
    <option value="Kanyama">Kanyama</option>
    <option value="Libala">Libala</option>
    <option value="Longacres">Longacres</option>
    <option value="Lusaka Town Area">Lusaka Town Area</option>
    <option value="Makeni">Makeni</option>
    <option value="Mandevu">Mandevu</option>
    <option value="Mass Media">Mass Media</option>
    <option value="Matero">Matero</option>
    <option value="Misisi">Misisi</option>
    <option value="Mtendere">Mtendere</option>
    <option value="Ng'ombe">Ng'ombe</option>
    <option value="Northmead">Northmead</option>
    <option value="Nyumba Yanga">Nyumba Yanga</option>
    <option value="Olympia Park">Olympia Park</option>
    <option value="PHI">PHI</option>
    <option value="Roma">Roma</option>
    <option value="Showgrounds">Showgrounds</option>
    <option value="Sunningdale">Sunningdale</option>
    <option value="Thorn Park">Thorn Park</option>
    <option value="Villa Elizabetha">Villa Elizabetha</option>
    <option value="Woodlands">Woodlands</option>
    <option value="Other">Other</option>


      </select>
      <input type="file" id="profilePhoto" accept="image/*" style="display: none;">
      <input type="password" id="password" placeholder="Password">
      
      <div class="auth-buttons">
        <button class="btn btn-primary" onclick="emailLogin()">Log In</button>
        <button class="btn btn-secondary" onclick="emailSignUp()">Create Account</button>
      </div>
    </div>
  </div>

  <!-- Job Details Section for Professionals -->
  <div class="job-details-container" id="jobDetailsSection" style="display: none;">
    <div class="auth-header">
      <h1>Complete Your Profile</h1>
      <p>Tell us about your skills and services</p>
    </div>
    
    <div class="auth-form">
      <select id="jobTitle">
        <option value="">Select Your Profession</option>
  
  <option value="Agricultural Extension Worker">Agricultural Extension Worker</option>
  <option value="Air Conditioning Technician">Air Conditioning Technician</option>
  <option value="Appliance Installer">Appliance Installer</option>
  <option value="Bartender">Bartender</option>
  <option value="Blogger / Content Creator">Blogger / Content Creator</option>
  <option value="Builder / Bricklayer">Builder / Bricklayer</option>
  <option value="Bus Conductor">Bus Conductor</option>
  <option value="Carpenter">Carpenter</option>
  <option value="Carpet Cleaner">Carpet Cleaner</option>
  <option value="Cashier">Cashier</option>
  <option value="Caterer">Caterer</option>
  <option value="Cleaner">Cleaner</option>
  <option value="Community Health Worker">Community Health Worker</option>
  <option value="Computer Repair Technician">Computer Repair Technician</option>
  <option value="Cook / Chef">Cook / Chef</option>
  <option value="Decorator">Decorator</option>
  <option value="Delivery Rider / Courier">Delivery Rider / Courier</option>
  <option value="DJ / Sound Technician">DJ / Sound Technician</option>
  <option value="Domestic Worker / Maid">Domestic Worker / Maid</option>
  <option value="Driver">Driver</option>
  <option value="Driving Instructor">Driving Instructor</option>
  <option value="Electrician">Electrician</option>
  <option value="Event Planner">Event Planner</option>
  <option value="Farmer">Farmer</option>
  <option value="Fashion Designer / Tailor">Fashion Designer / Tailor</option>
  <option value="Fisherman">Fisherman</option>
  <option value="Furniture Assembler">Furniture Assembler</option>
  <option value="Gardener">Gardener</option>
  <option value="Graphic Designer">Graphic Designer</option>
  <option value="Hairdresser / Barber">Hairdresser / Barber</option>
  <option value="Handyman">Handyman</option>
  <option value="House Maintenance">House Maintenance</option>
  <option value="IT Support Technician">IT Support Technician</option>
  <option value="Laundry Services">Laundry Services</option>
  <option value="Livestock Keeper">Livestock Keeper</option>
  <option value="Makeup Artist">Makeup Artist</option>
  <option value="Market Vendor / Trader">Market Vendor / Trader</option>
  <option value="Mechanic">Mechanic</option>
  <option value="Mover">Mover</option>
  <option value="Music Teacher">Music Teacher</option>
  <option value="Nurse / Caregiver">Nurse / Caregiver</option>
  <option value="Painter">Painter</option>
  <option value="Pest Control Technician">Pest Control Technician</option>
  <option value="Personal Trainer">Personal Trainer</option>
  <option value="Photographer">Photographer</option>
  <option value="Plumber">Plumber</option>
  <option value="Receptionist">Receptionist</option>
  <option value="Roofing Specialist">Roofing Specialist</option>
  <option value="Salesperson">Salesperson</option>
  <option value="Security Camera Installer">Security Camera Installer</option>
  <option value="Security Guard">Security Guard</option>
  <option value="Shop Attendant">Shop Attendant</option>
  <option value="Social Media Manager">Social Media Manager</option>
  <option value="Solar Panel Installer">Solar Panel Installer</option>
  <option value="Sports Coach">Sports Coach</option>
  <option value="Tailor">Tailor</option>
  <option value="Taxi Driver / Bolt Driver">Taxi Driver / Bolt Driver</option>
  <option value="Technician">Technician</option>
  <option value="Tiler">Tiler</option>
  <option value="Traditional Healer">Traditional Healer</option>
  <option value="Tutor">Tutor</option>
  <option value="TV Mounting Specialist">TV Mounting Specialist</option>
  <option value="Videographer">Videographer</option>
  <option value="Waiter / Waitress">Waiter / Waitress</option>
  <option value="Watchman">Watchman</option>
  <option value="Web Developer">Web Developer</option>
  <option value="Welder">Welder</option>

    <option value="Other">Other</option>
      </select>
      <textarea id="jobDescription" placeholder="Describe your skills and services (max 500 words)" rows="5" style="width: 100%; padding: 12px 16px; border: 1px solid var(--divider); border-radius: 6px; font-family: inherit; font-size: 16px;"></textarea>
      
      <div class="auth-buttons">
        <button class="btn btn-primary" onclick="saveJobDetails()">Save & Continue</button>
      </div>
    </div>
  </div>

  <!-- Main App Section -->
  <div id="mainSection" style="display:none;">
    <div class="main-container">
      <!-- Main Content -->
      <div class="main-content">
              <!-- Account Status Message (shown if account is suspended/deleted) -->
        <div id="accountStatusMessage" class="account-status-message" style="display: none;">
          <!-- Message will be populated here -->
        </div>
      
        <!-- Home Section -->
        <div id="homeSection" class="section active">
          <div class="search-container">
            <div class="search-box">
              <input type="text" id="searchInput" placeholder="Search for professionals or services..." onfocus="openSearchPage()">
              <button onclick="openSearchPage()"><i class="fas fa-search"></i></button>
            </div>
          </div>
          
          <div class="workers-list" id="workersList">
            <!-- Worker cards will be loaded here -->
          </div>
          
          <!-- Worker Profile View (hidden by default) -->
          <div id="workerProfileView" style="display: none;">
            <!-- Worker profile will be loaded here -->
          </div>
        </div>

        <!-- Favorites Section -->
        <div id="favoritesSection" class="section" style="display: none;">
          <div class="search-container">
            <h2>My Favorite Professionals</h2>
            <p>Your saved professionals for quick access</p>
          </div>
          
          <div class="workers-list" id="favoritesList">
            <!-- Favorite professionals will be loaded here -->
          </div>
          
          <div id="favoritesEmpty" style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
            <i class="fas fa-star" style="font-size: 48px; margin-bottom: 16px; color: #ddd;"></i>
            <h3>No favorites yet</h3>
            <p>Save your favorite professionals by clicking the star icon on their profile</p>
          </div>
        </div>

        <!-- Orders Section -->
        <div id="ordersSection" class="section" style="display: none;">
          <div class="orders-tabs">
            <div class="tab active" onclick="switchOrderTab('current')">Current Jobs</div>
            <div class="tab" onclick="switchOrderTab('history')">History</div>
          </div>
          
          <div id="currentOrdersList">
            <!-- Current orders will be loaded here -->
          </div>
          
          <div id="historyOrdersList" style="display: none;">
            <!-- Past orders will be loaded here -->
          </div>
        </div>

        <!-- Account Section -->
        <div id="accountSection" class="section" style="display: none;">
          <div class="account-section">
            <div class="account-header">
              <div class="account-avatar">
                <img id="accountAvatarImg" src="" alt="User Avatar">
              </div>
              <div class="account-info">
                <h2 id="accountUserName"></h2>
                <p id="accountUserType"></p>
              </div>
            </div>
            
            <div class="account-details">
              <div class="detail-item">
                <span>Email</span>
                <span id="accountEmail"></span>
              </div>
              <div class="detail-item">
                <span>Phone</span>
                <span id="accountPhone"></span>
              </div>
              <div class="detail-item" id="accountCityItem" style="display: none;">
                <span>City</span>
                <span id="accountCity"></span>
              </div>
              <div class="detail-item" id="accountAreaItem" style="display: none;">
                <span>Area</span>
                <span id="accountArea"></span>
              </div>
              <div class="detail-item" id="accountProfessionItem" style="display: none;">
                <span>Profession</span>
                <span id="accountProfession"></span>
              </div>
              <div class="detail-item">
                <span>Change Password</span>
                <span><i class="fas fa-chevron-right"></i></span>
              </div>
              <div class="detail-item" onclick="logout()" style="cursor: pointer; color: #f3425f;">
                <span>Logout</span>
                <span><i class="fas fa-sign-out-alt"></i></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
      <div class="nav-item active" onclick="showSection('home')">
        <i class="fas fa-home"></i>
        <span>Home</span>
      </div>
      <div class="nav-item" onclick="showSection('favorites')">
        <i class="fas fa-star"></i>
        <span>Favorites</span>
      </div>
      <div class="nav-item" onclick="showSection('orders')">
        <i class="fas fa-list"></i>
        <span>My Jobs</span>
      </div>
      <div class="nav-item" onclick="showSection('account')">
        <i class="fas fa-user"></i>
        <span>Account</span>
      </div>
    </div>
  </div>
  
    <!-- Complaint Modal -->
  <div class="modal" id="complaintModal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">File a Complaint</div>
        <p>Describe the issue with your account suspension/deletion</p>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="complaintReason">Complaint Reason</label>
          <select id="complaintReason" class="form-control">
            <option value="">Select Reason</option>
            <option value="wrongful_suspension">Wrongful Suspension</option>
            <option value="wrongful_deletion">Wrongful Account Deletion</option>
            <option value="unfair_reason">Unfair Reason Provided</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label for="complaintDetails">Detailed Explanation</label>
          <textarea id="complaintDetails" class="form-control" rows="4" placeholder="Please provide detailed explanation of your complaint..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeComplaintModal()">Cancel</button>
        <button class="btn btn-primary" onclick="submitComplaint()">Submit Complaint</button>
      </div>
    </div>
  </div>
  

  <!-- Chat Modal -->
  <div class="chat-modal" id="chatModal" style="display: none;">
    <div class="chat-container">
      <div class="chat-header">
        <h3 id="chatWithName">Chat</h3>
        <button onclick="closeChat()"><i class="fas fa-times"></i></button>
      </div>
      <div class="chat-messages" id="chatMessages">
        <!-- Messages will be loaded here -->
      </div>
      
      <!-- Booking Section in Chat -->
      <div class="chat-booking-section" id="chatBookingSection" style="display: none;">
        <div style="text-align: center; margin-bottom: 12px;">
          <strong>Ready to book this professional?</strong>
        </div>
        <div class="booking-actions">
          <button class="btn btn-primary" onclick="bookFromChat()" style="flex: 1;">
            <i class="fas fa-calendar-check"></i> Book Now
          </button>
        </div>
      </div>
      
      <div class="chat-input">
        <input type="text" id="chatMessageInput" placeholder="Type a message..." onkeypress="handleChatInputKeypress(event)">
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>

  <!-- Booking Modal -->
  <div class="modal" id="bookingModal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Book a Professional</div>
        <p>Provide details about the job you need done</p>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="jobTypeInput">Job Type</label>
          <input type="text" id="jobTypeInput" class="form-control" placeholder="e.g., Plumbing repair, Electrical work">
        </div>
        <div class="form-group">
          <label for="jobDescriptionInput">Job Description</label>
          <textarea id="jobDescriptionInput" class="form-control" rows="4" placeholder="Please describe the job you need in detail..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeBookingModal()">Cancel</button>
        <button class="btn btn-primary" id="confirmBookingBtn">Book Now</button>
      </div>
    </div>
  </div>

  <!-- Rating Modal -->
  <div class="modal" id="ratingModal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Rate This Job</div>
        <p>How would you rate the service you received?</p>
      </div>
      <div class="modal-body">
        <div class="rating-stars" id="ratingStars">
          <i class="fas fa-star rating-star" data-rating="1"></i>
          <i class="fas fa-star rating-star" data-rating="2"></i>
          <i class="fas fa-star rating-star" data-rating="3"></i>
          <i class="fas fa-star rating-star" data-rating="4"></i>
          <i class="fas fa-star rating-star" data-rating="5"></i>
        </div>
        <div class="form-group">
          <label for="ratingComment">Comments (Optional)</label>
          <textarea id="ratingComment" class="form-control" rows="3" placeholder="Share your experience..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeRatingModal()">Cancel</button>
        <button class="btn btn-primary" id="submitRatingBtn">Submit Rating</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore-compat.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBLyFEpT7g4h1w9q20AjDF65TCZHV8kwfo",
      authDomain: "career-connect-d84da.firebaseapp.com",
      projectId: "career-connect-d84da",
      storageBucket: "career-connect-d84da.firebasestorage.app",
      messagingSenderId: "663938489307",
      appId: "1:663938489307:web:21db9f2c173887d5d7e5fe",
    };

    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Global variables
    let currentUserData = null;
    let currentChatWith = null;
    let currentChatId = null;
    let isProfessionalInChat = false;
    let currentWorkerToBook = null;
    let currentJobToRate = null;
    let selectedRating = 0;
    let userFavorites = [];
    
    // Search-related variables
    let searchResults = [];
    let activeFilters = {};
    let currentSort = 'rating';

    // Helper function to get full image URL
    function getFullImageUrl(url) {
      if (!url) return '';
      if (url.startsWith('http')) return url;
      if (url.startsWith('/')) return 'https://brightboard.academy' + url;
      return url;
    }

    // Helper function to generate a color from a name
    function getColorFromName(name) {
      let hash = 0;
      for (let i = 0; i < name.length; i++) {
        hash = name.charCodeAt(i) + ((hash << 5) - hash);
      }
      let color = (hash & 0x00FFFFFF).toString(16).toUpperCase();
      return "00000".substring(0, 6 - color.length) + color;
    }

    // Search Page Functions
    function openSearchPage() {
      document.getElementById("searchPage").style.display = "flex";
      document.getElementById("searchPageInput").focus();
      
      // Copy the current search term if any
      const currentSearch = document.getElementById("searchInput").value;
      if (currentSearch) {
        document.getElementById("searchPageInput").value = currentSearch;
        executeSearch();
      }
    }

    function closeSearchPage() {
      document.getElementById("searchPage").style.display = "none";
      // Copy the search term back to the home page search
      const searchTerm = document.getElementById("searchPageInput").value;
      document.getElementById("searchInput").value = searchTerm;
    }

    function handleSearchPageKeypress(event) {
      if (event.key === 'Enter') {
        executeSearch();
      }
    }

    async function executeSearch() {
      const searchTerm = document.getElementById("searchPageInput").value.toLowerCase().trim();
      const resultsList = document.getElementById("searchResultsList");
      const workerProfileView = document.getElementById("searchPageWorkerProfile");
      
      // Hide worker profile and show results list
      workerProfileView.style.display = 'none';
      resultsList.style.display = 'flex';
      
      resultsList.innerHTML = '<p>Searching...</p>';
      
      try {
        let query = db.collection("users").where("accountType", "==", "professional");
        
        const snapshot = await query.get();
        searchResults = [];
        
        snapshot.forEach(doc => {
          const worker = doc.data();
          worker.uid = doc.id;
          
          // Check if worker matches search term
          const matchesSearch = !searchTerm || 
            worker.fullName.toLowerCase().includes(searchTerm) ||
            (worker.jobTitle && worker.jobTitle.toLowerCase().includes(searchTerm)) ||
            (worker.area && worker.area.toLowerCase().includes(searchTerm)) ||
            (worker.city && worker.city.toLowerCase().includes(searchTerm));
          
          if (matchesSearch) {
            searchResults.push(worker);
          }
        });
        
        // Apply filters
        await applyFilters();
        
        // Update results count
        document.getElementById("searchResultsCount").textContent = `${searchResults.length} results`;
        
        // Display results
        displaySearchResults();
        
      } catch (error) {
        console.error("Error searching workers: ", error);
        resultsList.innerHTML = '<p>Error searching. Please try again.</p>';
      }
    }

    async function applyFilters() {
      if (Object.keys(activeFilters).length === 0) {
        return; // No filters to apply
      }
      
      // Apply rating filter
      if (activeFilters.rating) {
        const minRating = parseInt(activeFilters.rating);
        
        // Filter workers based on their average rating
        const filteredResults = [];
        
        for (const worker of searchResults) {
          const ratingInfo = await getWorkerAverageRating(worker.uid);
          if (parseFloat(ratingInfo.average) >= minRating) {
            filteredResults.push(worker);
          }
        }
        
        searchResults = filteredResults;
      }
    }

    function displaySearchResults() {
      const resultsList = document.getElementById("searchResultsList");
      resultsList.innerHTML = '';
      
      if (searchResults.length === 0) {
        resultsList.innerHTML = '<p>No professionals found matching your criteria.</p>';
        return;
      }
      
      // Sort results
      sortResults(currentSort);
    }

    function toggleFilter(element) {
      const filterType = element.getAttribute('data-filter');
      const filterValue = element.getAttribute('data-value');
      
      // Toggle active state
      element.classList.toggle('active');
      
      // Update active filters
      if (element.classList.contains('active')) {
        activeFilters[filterType] = filterValue;
      } else {
        delete activeFilters[filterType];
      }
      
      // Re-apply filters and update results
      applyFilters().then(() => {
        document.getElementById("searchResultsCount").textContent = `${searchResults.length} results`;
        displaySearchResults();
      });
    }

    function toggleSortDropdown() {
      document.getElementById("sortDropdown").classList.toggle('show');
    }

    async function sortResults(sortType) {
      currentSort = sortType;
      
      // Close dropdown
      document.getElementById("sortDropdown").classList.remove('show');
      
      // Sort the results
      if (sortType === 'rating') {
        // Sort by rating (highest first)
        const sortedResults = [];
        
        // Get ratings for all workers
        for (const worker of searchResults) {
          const ratingInfo = await getWorkerAverageRating(worker.uid);
          worker.ratingValue = parseFloat(ratingInfo.average);
          sortedResults.push(worker);
        }
        
        sortedResults.sort((a, b) => b.ratingValue - a.ratingValue);
        searchResults = sortedResults;
      } else if (sortType === 'jobs') {
        // Sort by jobs completed (highest first)
        searchResults.sort((a, b) => (b.jobsCompleted || 0) - (a.jobsCompleted || 0));
      } else if (sortType === 'name') {
        // Sort by name (A-Z)
        searchResults.sort((a, b) => a.fullName.localeCompare(b.fullName));
      }
      
      // Display sorted results
      const resultsList = document.getElementById("searchResultsList");
      resultsList.innerHTML = '';
      
      // Create cards for each worker
      const workerCards = [];
      
      for (const worker of searchResults) {
        const workerCard = await createWorkerCard(worker, false);
        workerCards.push(workerCard);
      }
      
      // Append all cards to the list
      workerCards.forEach(card => {
        resultsList.appendChild(card);
      });
    }

    // Show worker profile in search page
    async function showSearchPageWorkerProfile(worker) {
      const resultsList = document.getElementById("searchResultsList");
      const workerProfileView = document.getElementById("searchPageWorkerProfile");
      
      // Hide results list and show worker profile
      resultsList.style.display = 'none';
      workerProfileView.style.display = 'block';
      
      workerProfileView.innerHTML = '<p>Loading profile...</p>';
      
      const detailedCard = await createWorkerCard(worker, true);
      workerProfileView.innerHTML = '';
      workerProfileView.appendChild(detailedCard);
    }

    // Close worker profile in search page
    function closeSearchPageWorkerProfile() {
      const resultsList = document.getElementById("searchResultsList");
      const workerProfileView = document.getElementById("searchPageWorkerProfile");
      
      // Show results list and hide worker profile
      resultsList.style.display = 'flex';
      workerProfileView.style.display = 'none';
    }

    // Account type selection
    function selectAccountType(type) {
      document.getElementById('normalAccountType').classList.remove('selected');
      document.getElementById('professionalAccountType').classList.remove('selected');
      document.getElementById(type + 'AccountType').classList.add('selected');
      
      const professionalFields = ['city', 'area', 'profilePhoto'];
      professionalFields.forEach(field => {
        document.getElementById(field).style.display = type === 'professional' ? 'block' : 'none';
      });
    }

    // Upload profile photo using PHP
    async function uploadProfilePhoto(file, userId) {
      try {
        const formData = new FormData();
        formData.append('file', file);
        
        const response = await fetch('https://brightboard.academy/upload.php', {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          throw new Error(`Upload failed with status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.url) {
          return data.url;
        } else {
          throw new Error(data.error || 'Upload failed');
        }
      } catch (error) {
        console.error("Error uploading profile photo:", error);
        throw error;
      }
    }

    // Auth functions
    async function emailSignUp() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const fullName = document.getElementById("fullName").value;
      const accountType = document.querySelector('.account-type.selected').id.replace('AccountType', '');
      
      if (!email || !password || !fullName) {
        alert("Please fill in all required fields");
        return;
      }
      
      if (password.length < 6) {
        alert("Password must be at least 6 characters long");
        return;
      }
      
      // Phone is required for all users
      const phone = document.getElementById("phone").value;
      if (!phone) {
        alert("Please provide your phone number");
        return;
      }
      
      if (accountType === 'professional') {
        const city = document.getElementById("city").value;
        const area = document.getElementById("area").value;
        const profilePhoto = document.getElementById("profilePhoto").files[0];
        
        if (!city || !area || !profilePhoto) {
          alert("Please fill in all professional fields");
          return;
        }
      }

      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        let profilePhotoURL = '';
        if (accountType === 'professional') {
          const profilePhoto = document.getElementById("profilePhoto").files[0];
          try {
            profilePhotoURL = await uploadProfilePhoto(profilePhoto, user.uid);
          } catch (uploadError) {
            console.error("Profile photo upload failed:", uploadError);
            alert("Profile photo upload failed. Please try again with a different image.");
            await user.delete();
            return;
          }
        }
        
        const userData = {
          uid: user.uid,
          email: email,
          fullName: fullName,
          accountType: accountType,
          phone: phone,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (accountType === 'professional') {
          userData.city = document.getElementById("city").value;
          userData.area = document.getElementById("area").value;
          userData.profilePhotoURL = profilePhotoURL;
          userData.rating = 0;
          userData.jobsCompleted = 0;
        }
        
        await db.collection("users").doc(user.uid).set(userData);
        
        if (accountType === 'professional') {
          document.getElementById("authSection").style.display = "none";
          document.getElementById("jobDetailsSection").style.display = "block";
        } else {
          showMainApp();
        }
      } catch (error) {
        console.error("Error creating account:", error);
        alert("Error creating account: " + error.message);
      }
    }
    
    async function emailLogin() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      
      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (error) {
        alert("Error signing in: " + error.message);
      }
    }
    
    function logout() {
      auth.signOut();
    }
    
    // Save job details for professionals
    async function saveJobDetails() {
      const user = auth.currentUser;
      if (!user) return;
      
      const jobTitle = document.getElementById("jobTitle").value;
      const jobDescription = document.getElementById("jobDescription").value;
      
      if (!jobTitle || !jobDescription) {
        alert("Please fill in all job details");
        return;
      }
      
      try {
        await db.collection("users").doc(user.uid).update({
          jobTitle: jobTitle,
          jobDescription: jobDescription
        });
        
        showMainApp();
      } catch (error) {
        alert("Error saving job details: " + error.message);
      }
    }
    
    // Show main app
    function showMainApp() {
      // Check if account is suspended or deleted
      if (currentUserData.accountStatus === 'suspended' || currentUserData.accountStatus === 'deleted') {
        // Limited functionality for suspended/deleted accounts
        document.getElementById("authSection").style.display = "none";
        document.getElementById("jobDetailsSection").style.display = "none";
        document.getElementById("mainSection").style.display = "block";
        document.getElementById("mainHeader").style.display = "flex";
        
        // Hide navigation and show only account section
        document.querySelector('.bottom-nav').style.display = 'none';
        showSection('account');
        
        loadUserData();
        return;
      }

      // Normal functionality for active accounts
      document.getElementById("authSection").style.display = "none";
      document.getElementById("jobDetailsSection").style.display = "none";
      document.getElementById("mainSection").style.display = "block";
      document.getElementById("mainHeader").style.display = "flex";
      
      document.querySelector('.bottom-nav').style.display = 'flex';
      
      loadUserData();
      loadWorkers();
      loadOrders();
      setupJobListeners();
      loadFavorites();
    }
    
    // Show account status message if suspended/deleted
    function showAccountStatusMessage() {
      const messageDiv = document.getElementById('accountStatusMessage');
      if (currentUserData.accountStatus === 'suspended') {
        messageDiv.innerHTML = `
          <h3><i class="fas fa-exclamation-triangle"></i> Account Suspended</h3>
          <p><strong>Reason:</strong> ${currentUserData.suspensionReason || 'No reason provided'}</p>
          <p>Your account has been temporarily suspended. You cannot access most features.</p>
          <button class="complaint-btn" onclick="openComplaintModal()">
            <i class="fas fa-flag"></i> File Complaint
          </button>
        `;
        messageDiv.style.display = 'block';
      } else if (currentUserData.accountStatus === 'deleted') {
        messageDiv.innerHTML = `
          <h3><i class="fas fa-ban"></i> Account Deleted</h3>
          <p><strong>Reason:</strong> ${currentUserData.deletionReason || 'No reason provided'}</p>
          <p>Your account has been permanently deleted.</p>
          <button class="complaint-btn" onclick="openComplaintModal()">
            <i class="fas fa-flag"></i> File Complaint
          </button>
        `;
        messageDiv.style.display = 'block';
      } else {
        messageDiv.style.display = 'none';
      }
    }

    // Complaint Modal Functions
    function openComplaintModal() {
      document.getElementById('complaintModal').style.display = 'flex';
    }

    function closeComplaintModal() {
      document.getElementById('complaintModal').style.display = 'none';
    }

    async function submitComplaint() {
      const reason = document.getElementById('complaintReason').value;
      const details = document.getElementById('complaintDetails').value;

      if (!reason || !details) {
        alert('Please fill in all complaint fields');
        return;
      }

      try {
        await db.collection('complaints').add({
          userId: auth.currentUser.uid,
          userName: currentUserData.fullName,
          userEmail: currentUserData.email,
          userType: currentUserData.accountType,
          reason: reason,
          details: details,
          accountStatus: currentUserData.accountStatus,
          adminReason: currentUserData.accountStatus === 'suspended' ? 
            currentUserData.suspensionReason : currentUserData.deletionReason,
          status: 'pending',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert('Complaint submitted successfully! We will review it soon.');
        closeComplaintModal();
      } catch (error) {
        console.error('Error submitting complaint:', error);
        alert('Error submitting complaint: ' + error.message);
      }
    }
    
    // Load user data
    async function loadUserData() {
      const user = auth.currentUser;
      if (!user) return;

      try {
        const userDoc = await db.collection("users").doc(user.uid).get();
        if (userDoc.exists) {
          currentUserData = userDoc.data();
          
          // Show account status message if suspended/deleted
          showAccountStatusMessage();

          document.getElementById("accountUserName").innerText = currentUserData.fullName;
          document.getElementById("accountUserType").innerText = currentUserData.accountType === 'professional' ? 'Professional' : 'User';
          document.getElementById("accountEmail").innerText = currentUserData.email;
          document.getElementById("accountPhone").innerText = currentUserData.phone || 'Not set';
          
          if (currentUserData.profilePhotoURL) {
            const fullPhotoUrl = getFullImageUrl(currentUserData.profilePhotoURL);
            document.getElementById("headerUserAvatarImg").src = fullPhotoUrl;
            document.getElementById("accountAvatarImg").src = fullPhotoUrl;
            
            document.getElementById("headerUserAvatarImg").onerror = function() {
              this.style.display = 'none';
              document.getElementById("headerUserAvatar").innerHTML = currentUserData.fullName.charAt(0).toUpperCase();
            };
          } else {
            const initial = currentUserData.fullName.charAt(0).toUpperCase();
            document.getElementById("headerUserAvatar").innerHTML = initial;
            document.getElementById("headerUserAvatar").style.backgroundColor = '#' + getColorFromName(currentUserData.fullName);
          }
          
          if (currentUserData.accountType === 'professional') {
            document.getElementById("accountCityItem").style.display = 'flex';
            document.getElementById("accountAreaItem").style.display = 'flex';
            document.getElementById("accountProfessionItem").style.display = 'flex';
            document.getElementById("accountCity").innerText = currentUserData.city || 'Not set';
            document.getElementById("accountArea").innerText = currentUserData.area || 'Not set';
            document.getElementById("accountProfession").innerText = currentUserData.jobTitle || 'Not set';
          }
        }
      } catch (error) {
        console.error("Error loading user data:", error);
      }
    }

    // Load workers for home page
    async function loadWorkers() {
      const workersList = document.getElementById("workersList");
      workersList.innerHTML = '<p>Loading professionals...</p>';
      
      try {
        const snapshot = await db.collection("users")
          .where("accountType", "==", "professional")
          .get();
        
        workersList.innerHTML = '';
        
        if (snapshot.empty) {
          workersList.innerHTML = '<p>No professionals found in your area.</p>';
          return;
        }
        
        // Create an array to hold all worker cards
        const workerCards = [];
        
        // Create cards for each worker
        for (const doc of snapshot.docs) {
          const worker = doc.data();
          worker.uid = doc.id; // Make sure UID is included
          const workerCard = await createWorkerCard(worker, false);
          workerCards.push(workerCard);
        }
        
        // Append all cards to the list
        workerCards.forEach(card => {
          workersList.appendChild(card);
        });
        
      } catch (error) {
        console.error("Error loading workers: ", error);
        workersList.innerHTML = '<p>Error loading professionals. Please try again.</p>';
      }
    }

    // Create worker card (small layout)
    async function createWorkerCard(worker, isDetailed) {
      const card = document.createElement('div');
      card.className = isDetailed ? 'worker-profile' : 'worker-card';
      
      // Calculate average rating for this worker
      const ratingInfo = await getWorkerAverageRating(worker.uid);
      
      // Check if this worker is in user's favorites
      const isFavorite = userFavorites.includes(worker.uid);
      
      if (isDetailed) {
        card.innerHTML = `
          <div class="profile-header">
            <div class="profile-avatar">
              <img src="${getFullImageUrl(worker.profilePhotoURL)}" alt="${worker.fullName}" onerror="this.style.display='none'">
            </div>
            <div class="profile-details">
              <div class="profile-name">${worker.fullName}</div>
              <div class="profile-job">${worker.jobTitle || 'Professional'}</div>
              <div class="profile-location">${worker.area}, ${worker.city}</div>
              <div class="profile-stats">
                <div class="stat">
                  <div class="stat-value">${ratingInfo.average}</div>
                  <div class="stat-label">Rating</div>
                </div>
                <div class="stat">
                  <div class="stat-value">${ratingInfo.count}</div>
                  <div class="stat-label">Ratings</div>
                </div>
                <div class="stat">
                  <div class="stat-value">${worker.jobsCompleted || 0}</div>
                  <div class="stat-label">Jobs Done</div>
                </div>
              </div>
            </div>
            <button class="btn btn-outline" onclick="${isDetailed ? (document.getElementById("searchPage").style.display === "flex" ? "closeSearchPageWorkerProfile()" : "closeWorkerProfile()") : ''}" style="align-self: flex-start;">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="profile-description">
            ${worker.jobDescription || 'No description provided.'}
          </div>
          <div class="profile-actions">
            <button class="btn btn-secondary" onclick="startChat('${worker.uid}')">Message</button>
            <button class="btn btn-primary" onclick="openBookingModal('${worker.uid}')">Book Now</button>
          </div>
          <button class="favorite-btn ${isFavorite ? 'active' : ''}" onclick="toggleFavorite('${worker.uid}', event)">
            <i class="fas fa-star"></i>
          </button>
        `;
      } else {
        // Set up click event for the entire card to show worker profile
        card.onclick = () => {
          // Check if we're on the search page
          if (document.getElementById("searchPage").style.display === "flex") {
            // Show worker profile within search page
            showSearchPageWorkerProfile(worker);
          } else {
            // Regular behavior for home page
            showWorkerProfile(worker);
          }
        };
        
        card.innerHTML = `
          <div class="worker-avatar">
            <img src="${getFullImageUrl(worker.profilePhotoURL)}" alt="${worker.fullName}" onerror="this.style.display='none'">
          </div>
          <div class="worker-info">
            <div class="worker-name">${worker.fullName}</div>
            <div class="worker-job">${worker.jobTitle || 'Professional'}</div>
            <div class="worker-location">${worker.area}, ${worker.city}</div>
            <div class="worker-rating">
              <i class="fas fa-star"></i>
              <span>${ratingInfo.average} (${ratingInfo.count} ratings)</span>
            </div>
          </div>
          <button class="favorite-btn ${isFavorite ? 'active' : ''}" onclick="toggleFavorite('${worker.uid}', event)">
            <i class="fas fa-star"></i>
          </button>
        `;
      }
      
      return card;
    }

    // Toggle favorite status
    async function toggleFavorite(workerId, event) {
      event.stopPropagation(); // Prevent card click event
      
      const user = auth.currentUser;
      if (!user) return;
      
      try {
        const isCurrentlyFavorite = userFavorites.includes(workerId);
        
        if (isCurrentlyFavorite) {
          // Remove from favorites
          await db.collection("users").doc(user.uid).collection("favorites").doc(workerId).delete();
          userFavorites = userFavorites.filter(id => id !== workerId);
        } else {
          // Add to favorites
          await db.collection("users").doc(user.uid).collection("favorites").doc(workerId).set({
            addedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          userFavorites.push(workerId);
        }
        
        // Update the button state
        const favoriteBtn = event.target.closest('.favorite-btn');
        if (favoriteBtn) {
          favoriteBtn.classList.toggle('active', !isCurrentlyFavorite);
        }
        
        // If we're on the favorites page, reload the favorites
        if (document.getElementById("favoritesSection").style.display !== 'none') {
          loadFavorites();
        }
        
      } catch (error) {
        console.error("Error toggling favorite:", error);
        alert("Error updating favorites. Please try again.");
      }
    }

    // Load user's favorites
    async function loadFavorites() {
      const user = auth.currentUser;
      if (!user) return;
      
      const favoritesList = document.getElementById("favoritesList");
      const favoritesEmpty = document.getElementById("favoritesEmpty");
      
      try {
        const snapshot = await db.collection("users").doc(user.uid).collection("favorites").get();
        
        userFavorites = [];
        const favoriteWorkerIds = [];
        
        snapshot.forEach(doc => {
          userFavorites.push(doc.id);
          favoriteWorkerIds.push(doc.id);
        });
        
        if (favoriteWorkerIds.length === 0) {
          favoritesList.innerHTML = '';
          favoritesEmpty.style.display = 'block';
          return;
        }
        
        favoritesEmpty.style.display = 'none';
        favoritesList.innerHTML = '<p>Loading favorites...</p>';
        
        // Get the actual worker data for each favorite
        const workerPromises = favoriteWorkerIds.map(workerId => 
          db.collection("users").doc(workerId).get()
        );
        
        const workerSnapshots = await Promise.all(workerPromises);
        const workers = [];
        
        workerSnapshots.forEach(snapshot => {
          if (snapshot.exists) {
            const worker = snapshot.data();
            worker.uid = snapshot.id;
            workers.push(worker);
          }
        });
        
        favoritesList.innerHTML = '';
        
        if (workers.length === 0) {
          favoritesList.innerHTML = '<p>No favorite professionals found.</p>';
          favoritesEmpty.style.display = 'block';
          return;
        }
        
        // Create cards for each favorite worker
        const favoriteCards = [];
        
        for (const worker of workers) {
          const workerCard = await createWorkerCard(worker, false);
          favoriteCards.push(workerCard);
        }
        
        // Append all cards to the list
        favoriteCards.forEach(card => {
          favoritesList.appendChild(card);
        });
        
      } catch (error) {
        console.error("Error loading favorites:", error);
        favoritesList.innerHTML = '<p>Error loading favorites. Please try again.</p>';
      }
    }
    
    // Show worker profile (big layout)
    async function showWorkerProfile(worker) {
      const workerProfileView = document.getElementById("workerProfileView");
      workerProfileView.innerHTML = '<p>Loading profile...</p>';
      
      const detailedCard = await createWorkerCard(worker, true);
      workerProfileView.innerHTML = '';
      workerProfileView.appendChild(detailedCard);
      workerProfileView.style.display = 'block';
      
      document.getElementById("workersList").style.display = 'none';
    }

    // Close worker profile function
    function closeWorkerProfile() {
      const workerProfileView = document.getElementById("workerProfileView");
      workerProfileView.style.display = 'none';
      document.getElementById("workersList").style.display = 'flex';
    }
    
    // Search workers
    function searchWorkers() {
      const searchTerm = document.getElementById("searchInput").value.toLowerCase();
      const workerCards = document.querySelectorAll('.worker-card');
      
      workerCards.forEach(card => {
        const workerName = card.querySelector('.worker-name').textContent.toLowerCase();
        const workerJob = card.querySelector('.worker-job').textContent.toLowerCase();
        const workerLocation = card.querySelector('.worker-location').textContent.toLowerCase();
        
        if (workerName.includes(searchTerm) || workerJob.includes(searchTerm) || workerLocation.includes(searchTerm)) {
          card.style.display = 'flex';
        } else {
          card.style.display = 'none';
        }
      });
    }
    
    // Open booking modal
    function openBookingModal(workerId) {
      currentWorkerToBook = workerId;
      document.getElementById("jobTypeInput").value = "";
      document.getElementById("jobDescriptionInput").value = "";
      document.getElementById("bookingModal").style.display = "flex";
      
      // Set up the confirm button
      document.getElementById("confirmBookingBtn").onclick = () => bookWorker(workerId);
    }
    
    // Close booking modal
    function closeBookingModal() {
      document.getElementById("bookingModal").style.display = "none";
      currentWorkerToBook = null;
    }
    
    // Book a worker
    async function bookWorker(workerId) {
      const user = auth.currentUser;
      if (!user) return;
      
      // Get job details from form
      const jobDescription = document.getElementById("jobDescriptionInput").value;
      if (!jobDescription) {
        alert("Please describe the job you need.");
        return;
      }
      
      const jobType = document.getElementById("jobTypeInput").value;
      if (!jobType) {
        alert("Please specify the type of job.");
        return;
      }
      
      try {
        // Get client data to include in the job request
        const clientDoc = await db.collection("users").doc(user.uid).get();
        const clientData = clientDoc.data();
        
        await db.collection("jobs").add({
          clientId: user.uid,
          workerId: workerId,
          status: 'pending',
          clientName: clientData.fullName,
          clientPhone: clientData.phone || 'Not provided',
          clientEmail: clientData.email,
          jobType: jobType,
          jobDescription: jobDescription,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert('Job request sent successfully!');
        closeBookingModal();
        
        // Close the appropriate worker profile view
        if (document.getElementById("searchPage").style.display === "flex") {
          closeSearchPageWorkerProfile();
        } else {
          document.getElementById("workerProfileView").style.display = 'none';
          document.getElementById("workersList").style.display = 'flex';
        }
        
        loadOrders();
      } catch (error) {
        alert('Error sending job request: ' + error.message);
      }
    }
    
    // Book from chat
    async function bookFromChat() {
      if (!currentChatWith) return;
      openBookingModal(currentChatWith.uid);
    }
    
    // Open rating modal
    function openRatingModal(jobId) {
      currentJobToRate = jobId;
      selectedRating = 0;
      
      // Reset stars
      const stars = document.querySelectorAll('.rating-star');
      stars.forEach(star => star.classList.remove('active'));
      
      // Set up star click events
      stars.forEach(star => {
        star.onclick = function() {
          const rating = parseInt(this.getAttribute('data-rating'));
          selectedRating = rating;
          
          // Update stars display
          stars.forEach((s, index) => {
            if (index < rating) {
              s.classList.add('active');
            } else {
              s.classList.remove('active');
            }
          });
        };
      });
      
      document.getElementById("ratingComment").value = "";
      document.getElementById("ratingModal").style.display = "flex";
    }
    
    // Close rating modal
    function closeRatingModal() {
      document.getElementById("ratingModal").style.display = "none";
      currentJobToRate = null;
      selectedRating = 0;
    }
    
    // Load orders
    async function loadOrders() {
      const user = auth.currentUser;
      if (!user || !currentUserData) return;
      
      let currentQuery;
      if (currentUserData.accountType === 'professional') {
        currentQuery = db.collection("jobs")
          .where("workerId", "==", user.uid)
          .where("status", "in", ["pending", "accepted"]);
      } else {
        currentQuery = db.collection("jobs")
          .where("clientId", "==", user.uid)
          .where("status", "in", ["pending", "accepted"]);
      }
      
      const currentSnapshot = await currentQuery.get();
      const currentOrdersList = document.getElementById("currentOrdersList");
      currentOrdersList.innerHTML = '';
      
      if (currentSnapshot.empty) {
        currentOrdersList.innerHTML = '<p>No current jobs.</p>';
      } else {
        const orders = [];
        currentSnapshot.forEach(doc => {
          const order = doc.data();
          order.id = doc.id;
          orders.push(order);
        });
        
        orders.sort((a, b) => (b.updatedAt?.toMillis() || 0) - (a.updatedAt?.toMillis() || 0));
        
        orders.forEach(async (order) => {
          const orderCard = await createOrderCard(order);
          currentOrdersList.appendChild(orderCard);
        });
      }
      
      let historyQuery;
      if (currentUserData.accountType === 'professional') {
        historyQuery = db.collection("jobs")
          .where("workerId", "==", user.uid)
          .where("status", "in", ["completed", "rejected"]);
      } else {
        historyQuery = db.collection("jobs")
          .where("clientId", "==", user.uid)
          .where("status", "in", ["completed", "rejected"]);
      }
      
      const historySnapshot = await historyQuery.get();
      const historyOrdersList = document.getElementById("historyOrdersList");
      historyOrdersList.innerHTML = '';
      
      if (historySnapshot.empty) {
        historyOrdersList.innerHTML = '<p>No past jobs.</p>';
      } else {
        const orders = [];
        historySnapshot.forEach(doc => {
          const order = doc.data();
          order.id = doc.id;
          orders.push(order);
        });
        
        orders.sort((a, b) => (b.updatedAt?.toMillis() || 0) - (a.updatedAt?.toMillis() || 0));
        
        orders.forEach(async (order) => {
          const orderCard = await createOrderCard(order);
          historyOrdersList.appendChild(orderCard);
        });
      }
    }
    
    // Create order card
    async function createOrderCard(order, isRequest = false) {
      const card = document.createElement('div');
      card.className = 'order-card';
      
      let otherUser;
      if (currentUserData.accountType === 'professional') {
        otherUser = {
          fullName: order.clientName || 'Unknown Client',
          profilePhotoURL: '',
          jobTitle: 'Client'
        };
      } else {
        const userDoc = await db.collection("users").doc(order.workerId).get();
        otherUser = userDoc.data();
      }
      
      // Calculate rating for completed jobs
      let ratingDisplay = '';
      if (order.status === 'completed' && order.rated && order.rating) {
        ratingDisplay = `<div><strong>Your Rating:</strong> ${order.rating} ★</div>`;
      }
      
      card.innerHTML = `
        <div class="order-header">
          <div class="order-worker">
            <div class="order-worker-avatar">
              <img src="${getFullImageUrl(otherUser.profilePhotoURL)}" alt="${otherUser.fullName}" onerror="this.style.display='none'">
            </div>
            <div>
              <div>${otherUser.fullName}</div>
              <div>${otherUser.jobTitle || ''}</div>
            </div>
          </div>
          <div class="order-status status-${order.status}">${order.status}</div>
        </div>
        <div class="order-details">
          <div><strong>Job Type:</strong> ${order.jobType || 'General Service'}</div>
          <div><strong>Description:</strong> ${order.jobDescription || 'No description provided'}</div>
          <div><strong>Date:</strong> ${order.createdAt ? order.createdAt.toDate().toLocaleDateString() : 'Not specified'}</div>
          ${ratingDisplay}
          ${isRequest ? `
            <div><strong>Client:</strong> ${order.clientName || 'Unknown'}</div>
            <div><strong>Phone:</strong> ${order.clientPhone || 'Not provided'}</div>
            <div><strong>Email:</strong> ${order.clientEmail || 'Not provided'}</div>
          ` : ''}
        </div>
        <div class="order-actions">
          <button class="btn btn-secondary" onclick="startChat('${currentUserData.accountType === 'professional' ? order.clientId : order.workerId}', '${order.id}')">Message</button>
          ${order.status === 'accepted' && currentUserData.accountType === 'professional' ? `
            <button class="btn btn-primary" onclick="completeJob('${order.id}')">Complete Job</button>
          ` : ''}
          ${order.status === 'completed' && currentUserData.accountType === 'normal' && !order.rated ? `
            <button class="btn btn-primary" onclick="openRatingModal('${order.id}')">Rate</button>
          ` : ''}
        </div>
      `;
      
      return card;
    }
    
    // Switch order tabs
    function switchOrderTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      document.getElementById('currentOrdersList').style.display = 'none';
      document.getElementById('historyOrdersList').style.display = 'none';
      
      document.getElementById(tab + 'OrdersList').style.display = 'block';
    }
    
    // Job actions for professionals
    async function acceptJob(jid) {
      try {
        await db.collection("jobs").doc(jid).update({
          status: 'accepted',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert('Job accepted!');
        loadOrders();
      } catch (error) {
        alert('Error accepting job: ' + error.message);
      }
    }
    
    async function rejectJob(jid) {
      try {
        await db.collection("jobs").doc(jid).update({
          status: 'rejected',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert('Job rejected.');
        loadOrders();
      } catch (error) {
        alert('Error rejecting job: ' + error.message);
      }
    }
    
    async function completeJob(jid) {
      try {
        await db.collection("jobs").doc(jid).update({
          status: 'completed',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        const user = auth.currentUser;
        const userDoc = await db.collection("users").doc(user.uid).get();
        const userData = userDoc.data();
        
        await db.collection("users").doc(user.uid).update({
          jobsCompleted: (userData.jobsCompleted || 0) + 1
        });
        
        alert('Job marked as completed!');
        loadOrders();
      } catch (error) {
        alert('Error completing job: ' + error.message);
      }
    }
    
    // Rate a completed job
    async function submitRating() {
      if (!selectedRating) {
        alert('Please select a rating');
        return;
      }

      try {
        // Update the job with the rating and comment
        await db.collection("jobs").doc(currentJobToRate).update({
          rated: true,
          rating: selectedRating,
          ratingComment: document.getElementById("ratingComment").value,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        closeRatingModal();
        alert('Thank you for your rating!');
        loadOrders();
      } catch (error) {
        console.error("Error submitting rating:", error);
        alert('Error submitting rating: ' + error.message);
      }
    }

    // Function to calculate average rating for a worker
    async function getWorkerAverageRating(workerId) {
      try {
        const workerJobs = await db.collection("jobs")
          .where("workerId", "==", workerId)
          .where("rated", "==", true)
          .get();
        
        let totalRating = 0;
        let ratedJobs = 0;
        
        workerJobs.forEach(doc => {
          const jobData = doc.data();
          if (jobData.rating && jobData.rated) {
            totalRating += jobData.rating;
            ratedJobs++;
          }
        });
        
        return {
          average: ratedJobs > 0 ? (totalRating / ratedJobs).toFixed(1) : 0,
          count: ratedJobs
        };
      } catch (error) {
        console.error("Error calculating rating:", error);
        return { average: 0, count: 0 };
      }
    }
    
    // Chat functions
    async function startChat(otherUserId, jid = null) {
      const user = auth.currentUser;
      if (!user) return;
      
      const chatId = [user.uid, otherUserId].sort().join('_');
      currentChatId = chatId;
      
      const otherUserDoc = await db.collection("users").doc(otherUserId).get();
      currentChatWith = otherUserDoc.data();
      
      document.getElementById("chatWithName").textContent = `Chat with ${currentChatWith.fullName}`;
      document.getElementById("chatModal").style.display = 'flex';
      
      // Show booking section only for normal users chatting with professionals
      isProfessionalInChat = currentChatWith.accountType === 'professional';
      if (currentUserData.accountType === 'normal' && isProfessionalInChat) {
        document.getElementById("chatBookingSection").style.display = 'block';
      } else {
        document.getElementById("chatBookingSection").style.display = 'none';
      }
      
      loadMessages(chatId);
      
      if (jid) {
        await db.collection("jobs").doc(jid).update({
          chatId: chatId
        });
      }
    }
    
    function closeChat() {
      document.getElementById("chatModal").style.display = 'none';
      currentChatWith = null;
      currentChatId = null;
      isProfessionalInChat = false;
    }
    
    async function loadMessages(chatId) {
      const messagesContainer = document.getElementById("chatMessages");
      messagesContainer.innerHTML = '<p>Loading messages...</p>';
      
      try {
        const snapshot = await db.collection("chats").doc(chatId)
          .collection("messages")
          .orderBy("timestamp", "asc")
          .get();
        
        messagesContainer.innerHTML = '';
        
        if (snapshot.empty) {
          messagesContainer.innerHTML = '<p>No messages yet. Start the conversation!</p>';
          return;
        }
        
        snapshot.forEach(doc => {
          const message = doc.data();
          const messageElement = document.createElement('div');
          messageElement.className = `message ${message.senderId === auth.currentUser.uid ? 'sent' : 'received'}`;
          
          messageElement.innerHTML = `
            <div class="message-content">
              ${message.text}
            </div>
          `;
          
          messagesContainer.appendChild(messageElement);
        });
        
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      } catch (error) {
        console.error("Error loading messages: ", error);
        messagesContainer.innerHTML = '<p>Error loading messages.</p>';
      }
    }
    
    async function sendMessage() {
      const user = auth.currentUser;
      if (!user || !currentChatId || !currentChatWith) return;
      
      const messageInput = document.getElementById("chatMessageInput");
      const messageText = messageInput.value.trim();
      
      if (!messageText) return;
      
      try {
        await db.collection("chats").doc(currentChatId).collection("messages").add({
          senderId: user.uid,
          text: messageText,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        messageInput.value = '';
        loadMessages(currentChatId);
      } catch (error) {
        alert('Error sending message: ' + error.message);
      }
    }
    
    // Handle enter key in chat
    function handleChatInputKeypress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }
    
    // Section navigation
    function showSection(section) {
      document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
      document.getElementById(section + 'Section').style.display = 'block';
      
      document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
      event.currentTarget.classList.add('active');
      
      if (section === 'home') {
        document.getElementById("workerProfileView").style.display = 'none';
        document.getElementById("workersList").style.display = 'flex';
      } else if (section === 'favorites') {
        loadFavorites();
      }
    }

    // Set up real-time listeners for job updates
    function setupJobListeners() {
      const user = auth.currentUser;
      if (!user || !currentUserData) return;
      
      if (currentUserData.accountType === 'professional') {
        db.collection("jobs")
          .where("workerId", "==", user.uid)
          .where("status", "==", "pending")
          .onSnapshot((snapshot) => {
            snapshot.docChanges().forEach((change) => {
              if (change.type === "added") {
                if (document.getElementById("ordersSection").style.display !== 'none') {
                  loadOrders();
                }
              }
            });
          });
      }
      
      if (currentUserData.accountType === 'normal') {
        db.collection("jobs")
          .where("clientId", "==", user.uid)
          .onSnapshot((snapshot) => {
            snapshot.docChanges().forEach((change) => {
              if (change.type === "modified") {
                if (document.getElementById("ordersSection").style.display !== 'none') {
                  loadOrders();
                }
              }
            });
          });
      }
    }

    // Auth state listener
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        try {
          await loadUserData();
          
          if (currentUserData && currentUserData.accountType === 'professional' && !currentUserData.jobTitle) {
            document.getElementById("authSection").style.display = "none";
            document.getElementById("jobDetailsSection").style.display = "block";
          } else {
            showMainApp();
          }
        } catch (error) {
          console.error("Error loading user data:", error);
        }
      } else {
        document.getElementById("authSection").style.display = "block";
        document.getElementById("mainSection").style.display = "none";
        document.getElementById("mainHeader").style.display = "none";
        document.getElementById("jobDetailsSection").style.display = "none";
        currentUserData = null;
        userFavorites = [];
      }
    });

    // Initialize account type to normal
    selectAccountType('normal');
    
    // Set up rating modal submit button
    document.getElementById("submitRatingBtn").onclick = submitRating;
  </script>
</body>
</html>